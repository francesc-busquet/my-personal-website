<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-02-23">

<title>Data-driven web applications basics: Improving the architecture – Francesc Busquet</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../assets/favicon/favicon.ico" rel="icon">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark-b53751a350365c71b6c909e95f209ed1.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-6c7e3f1c34892e0a9bdcbd024bcdb2c6.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark-f94391c9484f03829d123dd1c092557f.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="../../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script>
  
  function getGiscusTheme() {
  const quartoTheme = localStorage.getItem("quarto-color-scheme");
  const giscusTheme = quartoTheme === "alternate" ? "dark" : "light";
  return giscusTheme;
}

function setGiscusTheme() {
  function sendMessage(message) {
    const iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe) return;
    iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
  }
  sendMessage({
    setConfig: {
      theme: getGiscusTheme(),
    },
  });
}

document.addEventListener('DOMContentLoaded', function () {
  const giscusAttributes = {
    "src": "https://giscus.app/client.js",
    "data-repo": "francesc-busquet/my-personal-website",
    "data-repo-id": "R_kgDOKbDmgw",
    "data-category": "General",
    "data-category-id": "DIC_kwDOKbDmg84CZzPu",
    "data-mapping": "title",
    "data-strict": "1",
    "data-reactions-enabled": "1",
    "data-emit-metadata": "0",
    "data-input-position": "top",
    "data-theme": getGiscusTheme(),
    "data-lang": "en",
    "crossorigin": "anonymous",
    "async": "",
  };

  // Dynamically create script tag
  const giscusScript = document.createElement("script");
  Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value));
  document.body.appendChild(giscusScript);

  // Update giscus theme when theme switcher is clicked
  const toggle = document.querySelector('.quarto-color-scheme-toggle');
  if (toggle) {
    toggle.addEventListener('click', setGiscusTheme);
  }
});
  
</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../posts/index.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Data-driven web applications basics: Improving the architecture</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Redis</div>
                <div class="quarto-category">cache</div>
                <div class="quarto-category">Celery</div>
                <div class="quarto-category">batching</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 23, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#home-page-url-submission-and-database-inserts" id="toc-home-page-url-submission-and-database-inserts" class="nav-link active" data-scroll-target="#home-page-url-submission-and-database-inserts">Home page: URL Submission and database inserts</a></li>
  <li><a href="#top-favorite-websites-page-querying-for-popular-urls" id="toc-top-favorite-websites-page-querying-for-popular-urls" class="nav-link" data-scroll-target="#top-favorite-websites-page-querying-for-popular-urls">Top Favorite Websites page: Querying for popular URLs</a></li>
  <li><a href="#bringing-it-all-together" id="toc-bringing-it-all-together" class="nav-link" data-scroll-target="#bringing-it-all-together">Bringing it all together</a></li>
  <li><a href="#implementing-these-changes-into-our-application" id="toc-implementing-these-changes-into-our-application" class="nav-link" data-scroll-target="#implementing-these-changes-into-our-application">Implementing these changes into our application</a>
  <ul class="collapse">
  <li><a href="#setting-up-redis" id="toc-setting-up-redis" class="nav-link" data-scroll-target="#setting-up-redis">Setting up Redis</a></li>
  <li><a href="#setting-up-celery" id="toc-setting-up-celery" class="nav-link" data-scroll-target="#setting-up-celery">Setting up Celery</a></li>
  <li><a href="#improving-the-home-page" id="toc-improving-the-home-page" class="nav-link" data-scroll-target="#improving-the-home-page">Improving the Home page</a></li>
  <li><a href="#improving-the-top-favorite-websites-page" id="toc-improving-the-top-favorite-websites-page" class="nav-link" data-scroll-target="#improving-the-top-favorite-websites-page">Improving the Top Favorite Websites page</a></li>
  </ul></li>
  <li><a href="#organizing-our-codebase" id="toc-organizing-our-codebase" class="nav-link" data-scroll-target="#organizing-our-codebase">Organizing our codebase</a>
  <ul class="collapse">
  <li><a href="#centralizing-shared-logic" id="toc-centralizing-shared-logic" class="nav-link" data-scroll-target="#centralizing-shared-logic">Centralizing shared logic</a></li>
  <li><a href="#organizing-celery-code" id="toc-organizing-celery-code" class="nav-link" data-scroll-target="#organizing-celery-code">Organizing Celery code</a></li>
  <li><a href="#organizing-flask-code" id="toc-organizing-flask-code" class="nav-link" data-scroll-target="#organizing-flask-code">Organizing Flask code</a></li>
  </ul></li>
  <li><a href="#containerizing-the-refactored-application" id="toc-containerizing-the-refactored-application" class="nav-link" data-scroll-target="#containerizing-the-refactored-application">Containerizing the refactored application</a>
  <ul class="collapse">
  <li><a href="#containerizing-the-flask-application" id="toc-containerizing-the-flask-application" class="nav-link" data-scroll-target="#containerizing-the-flask-application">Containerizing the Flask application</a></li>
  <li><a href="#containerizing-the-celery-application" id="toc-containerizing-the-celery-application" class="nav-link" data-scroll-target="#containerizing-the-celery-application">Containerizing the Celery application</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>In the previous posts of our series on building data-driven web applications, we developed a web application that allows users to submit their favorite websites and view a ranking of the most popular sites based on those submissions. We began by setting up the basic structure of the app using Flask, a lightweight web framework, and then integrated a PostgreSQL database to store user submissions, ensuring data persistence. Next, to leverage the stored data, we created a new page, the <em>Top Favorite Websites</em> page, where users could view the most popular websites based on the number of submissions. Finally, we contaibnerized the application using Docker to streamline deployment across different environments and facilitate scalability.</p>
<p>Now that the app is fully functional, we may start to think about deploying it for real-world usage. However, before moving forward, we need to evaluate whether there are any potential bottlenecks or areas of the application that might cause issues under real-world conditions. To do so, let’s take a moment to refresh our memory on how our application operates by reviewing what each page of the application does.</p>
<p>The <strong>Home page</strong> serves as the data submission component of the application. Here, users interact with the system by submitting their favorite website URLs. The page contains a simple form where users can input the URL of a website they want to submit. Upon entering a URL and clicking the <em>Register URL</em> button, the backend performs input validation to ensure that the submitted URL is properly formatted and valid. This step is crucial to prevent invalid data from being stored in the database. If the validation is successful, the URL is then stored in a PostgreSQL database. Once the URL has been successfully added to the database, the user receives a confirmation message indicating that their submission was successful.</p>
<p>In contrast, the <strong>Top Favorite Websites</strong> page serves as the data presentation component of the application. This page provides a user-friendly interface where users can view the ten most popular websites based on the submissions from the Home page. When a user accesses this page, the backend queries the database to count how many times each website has been submitted. These counts are then sorted in descending order, with the most frequently submitted websites appearing at the top of the list. The data is dynamically processed and used to render a table on the page, displaying the ten most popular websites.</p>
<p>All this information is graphically summarized in <a href="#fig-conceptual-interaction-data-flow-diagram" class="quarto-xref">Figure&nbsp;1</a>.</p>
<div id="fig-conceptual-interaction-data-flow-diagram" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-conceptual-interaction-data-flow-diagram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: center;">
<p><a href="assets/overview-app-dark-mode.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;1: Application interaction and data flow diagram"><img src="assets/overview-app-dark-mode.png" class="dark-figure img-fluid figure-img"></a></p>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: center;">
<p><a href="assets/overview-app.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;1: Application interaction and data flow diagram"><img src="assets/overview-app.png" class="light-figure img-fluid figure-img"></a></p>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-conceptual-interaction-data-flow-diagram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Application interaction and data flow diagram
</figcaption>
</figure>
</div>
<p>Upon examining the current architecture, a critical issue emerges: the application design places a significant and potentially unsustainable load on the database during periods of high user activity. This problem arises from the way data is handled in both the <em>Home</em> page and the <em>Top Favorite Websites</em> page. While the initial implementation worked well during development, it poses significant scalability challenges as the user base and data volume grow. Let’s delve deeper into the specific issues, analyzing each page to understand why the current design struggles under increasing demand.</p>
<section id="home-page-url-submission-and-database-inserts" class="level3">
<h3 class="anchored" data-anchor-id="home-page-url-submission-and-database-inserts">Home page: URL Submission and database inserts</h3>
<p>The Home page allows users to submit URLs, which are subsequently stored in a PostgreSQL database. Each submission triggers an individual insert operation, adding the URL to the <code>registered_urls</code> table. While this straightforward approach works well under low-traffic conditions, it introduces significant challenges during periods of peak usage.</p>
<p>Consider a scenario where a surge of users simultaneously submits URLs. In such cases, the system processes each request independently, with every submission initiating a new insert operation. This creates a flood of database insertions, generating a substantial load on the database.</p>
<section id="potential-improvement-grouping-multiple-individual-inserts" class="level4">
<h4 class="anchored" data-anchor-id="potential-improvement-grouping-multiple-individual-inserts">Potential improvement: Grouping multiple individual inserts</h4>
<p>A potential solution to this issue is to group multiple submissions into a single insert operation. Rather than processing each submission individually, submissions can be aggregated and inserted in one batch. For instance, instead of executing ten separate insert commands for ten submissions, the system could combine these into a single operation that inserts all ten URLs simultaneously. This reduces the number of database writes, alleviating system load and enhancing performance during high-traffic periods. This method of consolidating tasks or operations to process them collectively is known as batching.</p>
<p>To implement batching effectively, we can introduce a queue—a data structure that temporarily holds and organizes incoming submissions—to manage the process. When users submit URLs, these submissions are stored in the queue, which accumulates them over a short time interval or until a predefined threshold is met. Once the batch is ready, the system processes all submissions in a single insert operation.</p>
<p>To better illustrate this, let’s consider an example, Over a short period, three users submit URLs: User 1 submits <em>www.google.com</em> as one of their favorite websites, User 2 also submits <em>www.google.com</em>, and User 3 submits <em>www.facebook.com</em>. These URLs are stored in the queue as they arrive. After some time, once the system determines that enough submissions have accumulated or the predefined time interval has passed, it checks the queue and processes the entire batch. All the URLs are then inserted into the database in a single insert operation, reducing overhead and improving efficiency. This example is schematically represented in <a href="#fig-schematic-example-batching-with-queue" class="quarto-xref">Figure&nbsp;2</a>.</p>
<div id="fig-schematic-example-batching-with-queue" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-schematic-example-batching-with-queue-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: center;">
<p><a href="assets/batching-schematic-representation-dark-mode.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Figure&nbsp;2: Schematic example of URLs submission batching process"><img src="assets/batching-schematic-representation-dark-mode.png" class="dark-figure img-fluid figure-img"></a></p>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: center;">
<p><a href="assets/batching-schematic-representation.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Figure&nbsp;2: Schematic example of URLs submission batching process"><img src="assets/batching-schematic-representation.png" class="light-figure img-fluid figure-img"></a></p>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-schematic-example-batching-with-queue-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Schematic example of URLs submission batching process
</figcaption>
</figure>
</div>
<section id="sec-implementation-details-queue" class="level5">
<h5 class="anchored" data-anchor-id="sec-implementation-details-queue">Defining implementation details</h5>
<p>Now that we have a clearer understanding of the problem and the proposed solution, let’s dive into the implementation details.</p>
<p>The first step is to establish a queue system that temporarily stores and organizes incoming URL submissions before processing them in batches. This queue must be fast, scalable, and capable of efficiently handling a high volume of submissions, particularly during peak traffic periods. To meet these requirements, we’ll use <strong>Redis</strong>, a high-performance, in-memory key-value database. Redis is an excellent choice for this task due to its ability to perform rapid read and write operations entirely in memory, ensuring minimal latency and high throughput.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Key-value databases
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>A key-value database is a type of NoSQL database that stores data in the form of key-value pairs. In this structure, each key serves as a unique identifier, linked to a corresponding value. The value can be a simple data type, such as an integer, or a more complex structure like JSON, lists, or even BLOBs. <a href="#fig-simple-example-key-value-db" class="quarto-xref">Figure&nbsp;3</a> shows a simple example of a key-value database.</p>
<div id="fig-simple-example-key-value-db" class="invertImage quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-simple-example-key-value-db-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="assets/key-value-db-example.png" class="invertImage img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-simple-example-key-value-db-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Simple example of a key-value database
</figcaption>
</figure>
</div>
<p>Unlike traditional relational databases, key-value databases do not use a query language like SQL for searching or manipulating data. Instead, data is accessed solely through its unique key, which simplifies the database design and makes it highly efficient for specific use cases.</p>
<p>This simplicity and direct access mechanism enable key-value databases to easily scale horizontally across multiple servers. This same simplicity also contributes to their optimization for fast data retrieval, making them ideal for applications that require quick access to data.</p>
<p>Due to these characteristics, key-value databases excel in scenarios that involve high volumes of small, frequent read and write operations, such as session management, caching, and queue management.</p>
</div>
</div>
</div>
<p>In this system, Redis will serve as a temporary storage layer for submitted URLs. When users submit URLs, these will be added to the Redis queue instead of being immediately written to the PostgreSQL database. To achieve this, we’ll modify the backend logic to enqueue submissions into Redis, decoupling the submission process from the database writes. This approach ensures that the database is not overwhelmed by frequent, individual insert operations during periods of high activity.</p>
<p>To process the enqueued submissions, we need a mechanism that periodically retrieves and removes the accumulated data from Redis, groups the submissions into a single insert query, and writes them to the PostgreSQL database. This processing will occur at regular intervals—every <strong>5 minutes</strong> in this case. For this task, we’ll use <strong>Celery</strong>, a distributed task queue that supports asynchronous background task management. Celery will be configured to run a scheduled task that monitors the Redis queue, retrieves all enqueued URLs, consolidates them into a batch, removes them from the queue, and executes a bulk insert operation into the database.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Celery in a nutshell
</div>
</div>
<div class="callout-body-container callout-body">
<p>Celery is an open-source asynchronous task queue for distributed task execution. It enables applications to handle background tasks by offloading time-consuming operations to worker processes, which execute them asynchronously.</p>
<p>Celery consists of three main components:</p>
<ol type="1">
<li><strong>Tasks:</strong> Individual jobs that need to be executed asynchronously, such as sending notifications or generating reports. Tasks can also run synchronously if needed.</li>
<li><strong>Workers</strong>: Background processes fetch and execute tasks from a queue. Celery can distribute tasks across multiple workers or machines, enabling dynamic scaling based on workload.</li>
<li><strong>Messages</strong>: Communication pieces that hold the details of tasks. Each message in the queue specifies what needs to be done. Workers then pull these messages to identify and perform the corresponding tasks.</li>
</ol>
<p>To manage task communication, Celery relies on a <strong>message broker</strong>. A message broker is a middleware system that facilitates the exchange of messages between producers (applications that generate tasks) and consumers (workers that execute them). For instance Redis can be used as a message broker.</p>
<p>Here’s how it works in practice: The application (the client) sends tasks in the form of messages through the message broker, such as Redis. These messages are enqueued, awaiting execution. When a worker becomes available, it connects to the broker, checks the queue for pending tasks, and processes them as needed.</p>
</div>
</div>
<p><a href="#fig-updated-home-page-interaction-diagram" class="quarto-xref">Figure&nbsp;4</a> visually illustrates the updated architecture when submitting URLs on the Home page. Whenever a user submits a URL, such as www.google.com, it’s added to the Redis queue. Every 5 minutes, a Celery worker processes the queue and inserts all the URLs in a batch to the PostgreSQL database.</p>
<div id="fig-updated-home-page-interaction-diagram" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-updated-home-page-interaction-diagram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: center;">
<p><a href="assets/improving-app-with-batching-dark-mode.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Figure&nbsp;4: Home page interaction and data flow diagram with Redis and Celery integration"><img src="assets/improving-app-with-batching-dark-mode.png" class="dark-figure img-fluid figure-img"></a></p>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: center;">
<p><a href="assets/improving-app-with-batching.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6" title="Figure&nbsp;4: Home page interaction and data flow diagram with Redis and Celery integration"><img src="assets/improving-app-with-batching.png" class="light-figure img-fluid figure-img"></a></p>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-updated-home-page-interaction-diagram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: <em>Home</em> page interaction and data flow diagram with Redis and Celery integration
</figcaption>
</figure>
</div>
</section>
</section>
</section>
<section id="top-favorite-websites-page-querying-for-popular-urls" class="level3">
<h3 class="anchored" data-anchor-id="top-favorite-websites-page-querying-for-popular-urls">Top Favorite Websites page: Querying for popular URLs</h3>
<p>The issues are even more pronounced in the implementation of the <em>Top Favorite Websites</em> page. The design relies on querying the PostgreSQL database each time a user accesses the page. Specifically, for each user, the backend counts the occurrences of each submitted URL, sorts these counts in descending order, selects the top ten, and retrieves the results.</p>
<p>As the number of users grows, multiple users may access the <em>Top Favorite Websites</em> page simultaneously, triggering the same query multiple times, causing the database to process identical queries, each producing the same result. Even if the queries aren’t executed at the exact same time, but within a short time span, the outcome is still unlikely to change significantly. Despite this, the system continues to execute the same query for each user, leading to redundant database operations and unnecessary strain on the system.</p>
<p>Additionally, the impact of these repeated queries intensifies as the number of stored URLs increases. As the dataset grows, the complexity of the query increases as well. While counting and sorting a small dataset of hundred URLs might be fast, this process becomes more resource-intensive as the dataset expands to thousands or even millions of entries.</p>
<section id="potential-improvement-optimizing-performance-through-reusable-results" class="level4">
<h4 class="anchored" data-anchor-id="potential-improvement-optimizing-performance-through-reusable-results">Potential improvement: Optimizing performance through reusable results</h4>
<p>To address this challenge, rather than running a separate database query for each simultaneous user accessing the <em>Top Favorite Websites</em> to count the total number of submissions for each URL, we can compute the results once and reuse them for all users who visit the page simultaneously.</p>
<p>However, the redundancy in our current implementation extends beyond simultaneous users. The top ten websites are unlikely to change notoriously in short time spans, even as new submissions are added. This means that the results of our query remain largely valid not only for users accessing the page at the same time but also for users accessing it within a brief window of time. Recognizing this, we can push optimization further by reducing the frequency of queries even more. Instead of recalculating the top ten websites for every request or even every simultaneous batch of requests, we could calculate it periodically—say, once every thirty minutes—and reuse the same result for all users accessing the page during that interval.</p>
<p>Therefore, we can periodically precompute the results and temporarily store them in memory. By doing so, we can directly serve the precomputed results to users without needing to repeatedly query the database. This technique, known as <strong>caching</strong>, allows us to store frequently requested data temporarily and avoid redundant operations, thereby speeding up response times for future requests.</p>
<section id="defining-implementation-details" class="level5">
<h5 class="anchored" data-anchor-id="defining-implementation-details">Defining implementation details</h5>
<p>Now that we know what needs to be done, let’s specify how to implement it. The first step is to set up a cache to store the precomputed list of the top ten most submitted URLs. <strong>Redis</strong> is an ideal choice for this because it’s an in-memory data store, meaning it can retrieve and store data much faster than traditional disk-based databases. Caching relies on low-latency access to data, and Redis is specifically designed for this purpose.</p>
<p>To populate and update this cache with data from PostgreSQL, we can use <strong>Celery</strong> to schedule periodic tasks. These tasks will query the PostgreSQL database, compute the top ten most submitted URLs, and update the Redis cache accordingly.</p>
<p>Once the cache is in place, we’ll modify the backend to fetch the precomputed data directly from Redis instead of querying the PostgreSQL database every time a user visits the <em>Top Favorite Websites</em> page.</p>
<p><a href="#fig-updated-top-favorite-page-interaction-diagram" class="quarto-xref">Figure&nbsp;5</a> visually illustrates the updated architecture for displaying the <em>Top Favorite Websites</em> page. When a user visits this page, the backend fetches a precomputed table of popular URLs directly from Redis.</p>
<p>In the background, a Celery worker runs every 30 minutes. It connects to the PostgreSQL database, extracts the top 10 most popular URLs, and updates the cached table in Redis.</p>
<div id="fig-updated-top-favorite-page-interaction-diagram" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-updated-top-favorite-page-interaction-diagram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: center;">
<p><a href="assets/improving-app-with-caching-dark-mode.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7" title="Figure&nbsp;5: Top Favorite Websites page interaction and data flow diagram with Redis and Celery integration"><img src="assets/improving-app-with-caching-dark-mode.png" class="dark-figure img-fluid figure-img"></a></p>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: center;">
<p><a href="assets/improving-app-with-caching.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8" title="Figure&nbsp;5: Top Favorite Websites page interaction and data flow diagram with Redis and Celery integration"><img src="assets/improving-app-with-caching.png" class="light-figure img-fluid figure-img"></a></p>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-updated-top-favorite-page-interaction-diagram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: <em>Top Favorite Websites</em> page interaction and data flow diagram with Redis and Celery integration
</figcaption>
</figure>
</div>
</section>
</section>
</section>
<section id="bringing-it-all-together" class="level3">
<h3 class="anchored" data-anchor-id="bringing-it-all-together">Bringing it all together</h3>
<p>With the implementation of these updates, the backend architecture has been transformed to address scalability challenges and efficiently handle high-traffic scenarios. Previously, the backend directly queried the PostgreSQL database for every user request, creating significant performance bottlenecks during peak activity. By integrating Redis as an intermediary layer for both submission handling and caching, the system now reduces database load and improves responsiveness.</p>
<p>For the <em>Home</em> page, URL submissions are no longer written directly to the database. Instead, they are added to a Redis queue, decoupling user interactions from immediate database operations. A Celery worker processes the queue every five minutes, batching submissions into a single bulk insert to PostgreSQL. This reduces the frequency of database writes, ensuring smooth performance even under heavy traffic.</p>
<p>The <em>Top Favorite Websites</em> page has been similarly optimized. Instead of querying the database for every user request, the backend now retrieves precomputed results from a Redis cache. These results, representing the top ten most submitted URLs, are updated every thirty minutes by a Celery worker that queries PostgreSQL, calculates the top URLs, and refreshes the cache. This eliminates redundant queries and ensures faster response times.</p>
<p>These enhancements are visually summarized in <a href="#fig-updated-interaction-data-flow-diagram" class="quarto-xref">Figure&nbsp;6</a>, highlighting how user interactions with the two pages are now handled. This is a significant improvement over the previous architecture, depicted in <a href="#fig-conceptual-interaction-data-flow-diagram" class="quarto-xref">Figure&nbsp;1</a>, where user interactions directly accessed the PostgreSQL database, leading to performance bottlenecks during peak usage.</p>
<div id="fig-updated-interaction-data-flow-diagram" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-updated-interaction-data-flow-diagram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: center;">
<p><a href="assets/updated-overview-app-dark-mode.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9" title="Figure&nbsp;6: Application interaction and data flow diagram with Redis and Celery integration"><img src="assets/updated-overview-app-dark-mode.png" class="dark-figure img-fluid figure-img"></a></p>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 100.0%;justify-content: center;">
<p><a href="assets/updated-overview-app.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10" title="Figure&nbsp;6: Application interaction and data flow diagram with Redis and Celery integration"><img src="assets/updated-overview-app.png" class="light-figure img-fluid figure-img"></a></p>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-updated-interaction-data-flow-diagram-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Application interaction and data flow diagram with Redis and Celery integration
</figcaption>
</figure>
</div>
</section>
<section id="implementing-these-changes-into-our-application" class="level2">
<h2 class="anchored" data-anchor-id="implementing-these-changes-into-our-application">Implementing these changes into our application</h2>
<p>Having identified the key areas for improvement and outlined the necessary changes, we are now ready to implement these optimizations. To achieve this, we will need to set up Redis, integrate Celery for task scheduling, and create the necessary background tasks to handle the periodic processes. Additionally, we’ll update the backend logic to interact with Redis instead of directly querying the PostgreSQL database. Let’s walk through each of these steps in detail.</p>
<section id="setting-up-redis" class="level3">
<h3 class="anchored" data-anchor-id="setting-up-redis">Setting up Redis</h3>
<p>The first step in implementing these changes is to set up Redis, which will serve two critical roles: as a cache for the Top Favorite Websites table and as a queue for managing URL submissions from the Home page.</p>
<p>One of the simplest and most efficient ways to use Redis is through its official container images. Essentially, Redis offers two official Docker images:</p>
<ol type="1">
<li><p><code>redis/redis-stack-server</code>: A lightweight image that includes only the Redis Stack server. This image is ideal for production deployments.</p></li>
<li><p><code>redis/redis-stack</code>: This image includes both the Redis Stack server and RedisInsight, making it perfect for local development as you can leverage the integrated RedisInsight tool to visualize and manage your data.</p></li>
</ol>
<p>Redis provides detailed documentation on how to download and use these images, which can be found at the following link: <a href="https://redis.io/docs/install/install-stack/docker/">Redis Docker Installation Guide</a>.</p>
<p>In our case, we’ll go with the <code>redis/redis-stack</code> image to take advantage of RedisInsight, which will make it easier to debug and monitor the data flow during the development process.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
RedisInsight
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>RedisInsight is a graphical user interface (GUI) tool for Redis that enables you to visualize, interact with, and manage data stored in a Redis database. It provides an intuitive way to explore datasets, execute queries, inspect keys, monitor performance, and perform various data management tasks.</p>
</div>
</div>
</div>
<p>To download and run the Redis container, we will execute the following command in the terminal:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">--name</span> redis-stack <span class="at">-p</span> 6379:6379 <span class="at">-p</span> 8001:8001 redis/redis-stack:latest</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This command instructs Docker to create and start a container using the <code>redis/redis-stack:latest</code> image. The <code>--name redis-stack</code> flag assigns the container a recognizable name (<code>redis-stack</code>) for easy management. The <code>-p</code> flags map ports between the container and the host machine, with port 6379 used by Redis for database connections and port 8001 used by RedisInsight, a web-based UI for managing and visualizing Redis data.</p>
<p>When you execute this command, Docker will first check if the <code>redis/redis-stack:latest</code> image is available locally. If it isn’t found, Docker will proceed to download the image from the Docker registry, as shown in <a href="#fig-redis-stack-image-download-and-run" class="quarto-xref">Figure&nbsp;7</a>.</p>
<p>It’s important to note that the Docker engine must be running on your system for this command to execute properly.</p>
<div id="fig-redis-stack-image-download-and-run" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-redis-stack-image-download-and-run-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="assets/docker-redis-stack.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-redis-stack-image-download-and-run-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Downloading and running the <code>redis-stack</code> image
</figcaption>
</figure>
</div>
<p>After the image is successfully downloaded, Docker will automatically start the container. At this point, Redis will be up and running, accessible through port 6379, and RedisInsight will be available through port 8001, ready to provide a graphical interface for managing Redis.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Managing Docker containers
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>To view information about all the containers on your system, regardless of their current state (whether they are running or not), you can use the following command in the terminal:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> ps <span class="at">-a</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This command lists all containers on your system and provides details such as their names, the images they are based on, their creation time, and their current status.</p>
<div id="fig-output-docker-ps-a" class="lightbox quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-output-docker-ps-a-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="assets/docker containers info.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11" title="Figure&nbsp;8: docker ps -a output"><img src="assets/docker containers info.png" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-output-docker-ps-a-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: <code>docker ps -a</code> output
</figcaption>
</figure>
</div>
<p><a href="#fig-output-docker-ps-a" class="quarto-xref">Figure&nbsp;8</a> shows an example of the output you’ll see after running this command. As you can see, the output of this command includes several columns with key information about each container:</p>
<ul>
<li><p><strong><code>CONTAINER ID</code></strong>: A unique identifier for the container, usually shown as a short alphanumeric string (e.g., <code>72cb722bfa5d</code>).</p></li>
<li><p><strong><code>IMAGE</code></strong>: The Docker image that the container is based on, such as <code>redis/redis-stack:latest</code>.</p></li>
<li><p><strong><code>COMMAND</code></strong>: This column shows the command that is being executed inside the container once it starts running. For example, for a Flask application, this could be <code>flask run</code>.</p></li>
<li><p><strong><code>CREATED</code></strong>: The timestamp indicating when the container was created.</p></li>
<li><p><strong><code>STATUS</code></strong>: The current state of the container, such as <code>running</code>, <code>exited</code>, or <code>paused</code>.</p></li>
<li><p><strong><code>PORTS</code>:</strong> The ports exposed by the container and the corresponding ports on the host machine. For example, in the case of the <code>redis-stack</code> container, you can see <code>0.0.0.0:6379-&gt;6379/tcp</code>. This means that port 6379 inside the container is mapped to port 6379 on the host machine, allowing external access to the container’s Redis service through that port.</p></li>
<li><p><strong><code>NAMES</code></strong>: The names assigned to the containers. If you didn’t specify a name when creating the container, Docker will automatically assign a random name (e.g., <code>gracious_tesla</code>). If you did specify a name, it will appear here (e.g., <code>redis-stack</code>).</p></li>
</ul>
<p>With the information provided by <code>docker ps -a</code>, you can manage the state of your containers using the following commands:</p>
<ul>
<li><p><strong>Start a Container</strong>: To start a stopped container, you can use the <code>docker start</code> command followed by the container name or ID. For example, to start the <code>redis-stack</code> container, you would run the following command:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> start redis-stack</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>Stop a Container</strong>: To stop a running container, use the <code>docker stop</code> command. For example, to stop the <code>redis-stack</code> container, you would run the following command:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> stop redis-stack</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
</div>
</div>
</div>
<section id="accessing-redisinsight" class="level4">
<h4 class="anchored" data-anchor-id="accessing-redisinsight">Accessing RedisInsight</h4>
<p>With Redis and RedisInsight running, we can now access RedisInsight’s graphical interface by navigating to <a href="http://localhost:8001/" class="uri">http://localhost:8001/</a>.</p>
<p>Upon visiting this URL, the first thing we will need to do is accept the terms of service and configure the privacy settings for RedisInsight, as shown in <a href="#fig-redisInsight-terms-settings" class="quarto-xref">Figure&nbsp;9</a>.</p>
<div id="fig-redisInsight-terms-settings" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-redisInsight-terms-settings-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="assets/redisinsInsight-privacy-settings.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-redisInsight-terms-settings-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Accepting RedisInsight terms and configuring privacy settings
</figcaption>
</figure>
</div>
<p>Once we have accepted the RedisInsight terms of service, we will be directed to the main page where we can explore our Redis database, as well as create new keys, as shown in <a href="#fig-redisInsight-main-page" class="quarto-xref">Figure&nbsp;10</a>.</p>
<div id="fig-redisInsight-main-page" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-redisInsight-main-page-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="assets/redisInsight-main-page.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-redisInsight-main-page-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: RedisInsight main page
</figcaption>
</figure>
</div>
<p>On this page, we can see two main panels. The left panel displays all the keys in our Redis database. Since we haven’t created any keys yet, it’s currently empty. The right panel will allow us to explore the details of any key we click on, displaying the contents stored in that key.</p>
</section>
<section id="sec-connecting-to-redis" class="level4">
<h4 class="anchored">Connecting to Redis</h4>
<p>Now that Redis is up and running, it’s time to integrate it with our application. Similar to how we connected to our PostgreSQL database earlier in the project, we need to configure our application to interact with Redis.</p>
<p>To ensure that connection details are managed securely and are not hardcoded into our application, we’ll store them in the <code>.env</code> file. To do so, we will open the <code>.env</code> file and add the following lines to specify the Redis connection details:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>REDIS_HOST<span class="op">=</span><span class="st">'localhost'</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>REDIS_PORT<span class="op">=</span><span class="st">'6379'</span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Next, we can establish a connection to Redis by using the <code>redis</code> Python library, which provides a simple and efficient interface to interact with the Redis database.</p>
<p>If the <code>redis</code> library isn’t already installed, you can add it by running the following command:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install redis</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With the <code>redis</code> library installed and the environment variables already placed into the <code>.env</code> file, we can now import the <code>redis</code> library, retrieve the connection details from the <code>.env</code> file, and establish a connection to the Redis server with the following code:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> redis</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch Redis connection details from environment variables</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>redis_host <span class="op">=</span> os.getenv(<span class="st">'REDIS_HOST'</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>redis_port <span class="op">=</span> os.getenv(<span class="st">'REDIS_PORT'</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Establish connection to Redis</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>redis_conn <span class="op">=</span> redis.Redis(host<span class="op">=</span>redis_host, port<span class="op">=</span>redis_port)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>redis.Redis()</code> class is a central part of the Redis Python library, acting as an interface to interact with the Redis server. When you create an instance of this class, it establishes a connection to the specified Redis host and port. Allowing to execute Redis commands to manage data within the database.</p>
<p>To further organize the logic of connecting to Redis, we can create a custom <code>RedisClient</code> class. This class will handle the connection setup and provide a structured way to interact with Redis.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RedisClient:</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, host: <span class="bu">str</span>, port: <span class="bu">int</span>):</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.redis_host <span class="op">=</span> host</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.redis_port <span class="op">=</span> port</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.connection <span class="op">=</span> <span class="va">self</span>._connect()</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _connect(<span class="va">self</span>) <span class="op">-&gt;</span> redis.Redis:</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create a connection to the Redis server</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redis.Redis(host<span class="op">=</span><span class="va">self</span>.redis_host, port<span class="op">=</span><span class="va">self</span>.redis_port)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> redis.<span class="pp">ConnectionError</span> <span class="im">as</span> e:</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Failed to connect to Redis: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now that we’ve set up our <code>RedisClient</code> class, we can easily create an instance of it by passing in the connection details that we retrieved from the environment variables. This will initialize the connection to Redis, allowing us to interact with the Redis server.</p>
<p>To create the client, we can simply do:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>redis_client <span class="op">=</span> RedisClient(redis_host, <span class="bu">int</span>(redis_port))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With <code>redis_client</code> now initialized, we can use <code>redis_client.connection</code> to perform any Redis operations, such as setting or getting data.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Logging
</div>
</div>
<div class="callout-body-container callout-body">
<p>Logging is the process of recording information about events or actions that occur during the execution of a program. It gives developers and system administrators insights into the application’s performance and behavior, helping them monitor its status, detect issues, and troubleshoot problems efficiently.</p>
<p>For example, in our case, logging allows us to track key details such as when a task is triggered, how many URLs are processed, how long the process takes, and whether any errors occur during execution.</p>
<section id="logging-in-python" class="level3">
<h3 class="anchored" data-anchor-id="logging-in-python"><strong>Logging in Python</strong></h3>
<p>Python provides a built-in logging library called <code>logging</code>, which allows us to log messages with varying levels of severity. By default, these messages are displayed in the terminal, but they can also be saved to log files for later analysis. This flexibility allows for detailed tracking, whether it’s for real-time monitoring or for post-execution reviews.</p>
<p>The different severity levels help categorize messages according to their importance, allowing us to focus on critical information while filtering out less relevant details. The five standard logging levels are:</p>
<ol type="1">
<li><p><strong>DEBUG</strong>: Used for detailed, verbose messages that provide insights into the internal state of the program. This level is primarily useful during development and debugging.</p></li>
<li><p><strong>INFO</strong>: Used for general messages that indicate the normal operation of the application, such as logging when a task starts or finishes.</p></li>
<li><p><strong>WARNING</strong>: Used for potential issues that are not errors but may require attention. These are situations where something could go wrong in the future if left unaddressed.</p></li>
<li><p><strong>ERROR</strong>: Used for errors that occur during execution, signaling that something has gone wrong, but the program can still continue running.</p></li>
<li><p><strong>CRITICAL</strong>: Used for severe issues, indicating that the application may crash or become non-functional without immediate attention.</p></li>
</ol>
<section id="configuring-the-logging-system" class="level4">
<h4 class="anchored" data-anchor-id="configuring-the-logging-system">Configuring the Logging System</h4>
<p>The Python <code>logging</code> library gives us a lot of control over how log messages are captured and handled. Using the <code>basicConfig</code> method, we can configure important aspects of the logging system, such as which messages should be recorded, their format, and where they should be saved. Unlike <code>print</code> statements, which are primarily for quick debugging and lack flexibility, logging allows for structured and customizable output that can be filtered and redirected as needed.</p>
<p>For example, if we want to capture messages of severity <code>INFO</code> and above (which includes <code>INFO</code>, <code>WARNING</code>, <code>ERROR</code>, and <code>CRITICAL</code>), we can set the logging level by using this method as follows:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>logging.basicConfig(level<span class="op">=</span>logging.INFO)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Once we’ve incorporate the logging library, we can enhance the visibility and traceability of our code’s behavior. For instance, in the <code>RedisClient</code> class we just created, we can replace the <code>print</code> statement with a logging call to capture errors in a more structured way. Here’s the improved class with logging:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RedisClient:</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, host: <span class="bu">str</span>, port: <span class="bu">int</span>):</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.redis_host <span class="op">=</span> host</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.redis_port <span class="op">=</span> port</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.connection <span class="op">=</span> <span class="va">self</span>._connect()</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _connect(<span class="va">self</span>) <span class="op">-&gt;</span> redis.Redis:</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Establish a connection to Redis."""</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create a connection to the Redis server</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redis.Redis(host<span class="op">=</span><span class="va">self</span>.redis_host, port<span class="op">=</span><span class="va">self</span>.redis_port)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> redis.<span class="pp">ConnectionError</span> <span class="im">as</span> e:</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>            logging.error(<span class="ss">f"Failed to connect to Redis: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
</div>
</div>
</section>
</section>
<section id="setting-up-celery" class="level3">
<h3 class="anchored" data-anchor-id="setting-up-celery">Setting up Celery</h3>
<p>With Redis successfully set up, the next step is to configure Celery, which will manage our background tasks. Celery will periodically check the Redis queue, process any URLs found, and transfer them to the PostgreSQL database. It will also precompute and cache the top ten most submitted URLs from the PostgreSQL database into Redis.</p>
<p>To get started with Celery, we first need to install the Celery library, which we can do by running the following command in a terminal:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install celery</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In addition to Celery, we need a message broker to handle task messaging. Since Redis is already set up as our queue, we will configure Celery to use Redis as its message broker, taking advantage of our current setup and avoiding the need for an additional service.</p>
<p>Next, we need to set up Celery to run in the background by creating a new file named <strong>celery_app.py</strong>. In this file, we will define the Celery application, and specify Redis as the broker:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> celery <span class="im">import</span> Celery</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch Redis connection details from environment variables</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>redis_host <span class="op">=</span> os.getenv(<span class="st">'REDIS_HOST'</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>redis_port <span class="op">=</span> os.getenv(<span class="st">'REDIS_PORT'</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the Celery application and configure it to use Redis as the broker</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>app_celery <span class="op">=</span> Celery(broker<span class="op">=</span><span class="ss">f"redis://</span><span class="sc">{</span>redis_host<span class="sc">}</span><span class="ss">:</span><span class="sc">{</span>redis_port<span class="sc">}</span><span class="ss">/0"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After setting up Celery, we can proceed to define the tasks that need to be executed.</p>
</section>
<section id="improving-the-home-page" class="level3">
<h3 class="anchored" data-anchor-id="improving-the-home-page">Improving the Home page</h3>
<p>With Redis and Celery already set up, we’re now ready to enhance the URL submission on the Home page. As we discussed earlier, we’re moving from directly inserting URLs into the database to enqueuing them in Redis for deferred processing. To implement this change, we’ll begin by replacing the direct database insertion with a Redis queue. Then, we’ll create a Celery task to process and transfer these enqueued URLs into our PostgreSQL database.</p>
<section id="replacing-direct-database-insertion-with-a-redis-queue" class="level4">
<h4 class="anchored" data-anchor-id="replacing-direct-database-insertion-with-a-redis-queue">Replacing direct database insertion with a Redis queue</h4>
<p>In the current implementation, each time a user submits a URL, the backend first validates its format to ensure it’s correct. After validation, the URL is immediately inserted into PostgreSQL using the <code>insert_url_into_database</code> function. Below is the original implementation for reference:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> insert_url_into_database(url: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>        conn <span class="op">=</span> connect_to_database()</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>        cur <span class="op">=</span> conn.cursor()</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        cur.execute(<span class="st">"INSERT INTO registered_urls (url) VALUES (</span><span class="sc">%s</span><span class="st">)"</span>, (url,))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>        conn.commit()</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Error inserting URL into the database:"</span>, e)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        conn.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><a href="#sec-implementation-details-queue">As previously discussed</a>, the goal is to replace the direct insertion of URLs into PostgreSQL with a Redis queue. To achieve this, we will completely rewrite this function to enqueue the submitted URL into Redis instead of inserting it directly into the PostgreSQL database.</p>
<p>To implement this, we’ll use Redis’ <code>RPUSH</code> command. The <code>RPUSH</code> command inserts the specified values at the tail of a list stored at a given key. If the key doesn’t already exist, Redis will create it as an empty list before performing the push operation. In Python, we can execute this command using the <code>rpush</code> method, which is part of the Redis connection object. This connection object can be set up as described in the <a href="#sec-connecting-to-redis">Connecting to Redis</a> section. The <code>rpush</code> method takes two arguments: the key and the values we want to add to the list. In this case, we’ll name the key to store the urls as <code>url_queue</code>.</p>
<p>Here’s the updated function that enqueues submitted URLs into the Redis queue:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> enqueue_url_to_redis(url: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Push the URL to a Redis queue (list)</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        redis_client.connection.rpush(<span class="st">"url_queue"</span>, url)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        logging.debug(<span class="ss">f"URL enqueued to Redis: </span><span class="sc">{</span>url<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="st">"Error sending URL to Redis queue:"</span>, e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that we replaced the print statement with a logging call to capture errors in a more structured manner. In addition, we added logging for successful URL enqueueing to Redis, providing better visibility for debugging and tracking the function’s behavior.</p>
<p>Once we’ve replaced the <code>insert_url_into_database</code> function with <code>enqueue_url_to_redis</code>, the next step is to update the <code>process_url</code> function. Previously, this function called <code>insert_url_into_database</code> to directly store URLs in PostgreSQL. Now, we’ll modify it to use <code>enqueue_url_to_redis</code> instead:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_url(url: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_valid_url(url):</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>        enqueue_url_to_redis(url)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>        confirmation_message <span class="op">=</span> <span class="st">"You have successfully registered the following URL: "</span> <span class="op">+</span> url</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        confirmation_message <span class="op">=</span> <span class="st">"The URL you entered is not valid. Please check the format and try again."</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> confirmation_message</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After implementing these changes, it’s time to test everything. To accomplish this, we’ll start the application by opening a terminal in the directory where the <code>app.py</code> file is located and running the command <code>flask run</code>. Once the application is running, we can submit some URLs, such as <em>www.google.com</em> and <em>www.facebook.com</em>. Then, using RedisInsight, we’ll verify if the URL has been successfully added to the Redis queue. Specifically, we’ll verify that the <code>url_queue</code> key has been created and that it contains the submitted URL as shown in <a href="#fig-checking-submitted-urls-redisInsight" class="quarto-xref">Figure&nbsp;11</a>.</p>
<div id="fig-checking-submitted-urls-redisInsight" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-checking-submitted-urls-redisInsight-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="assets/checking-registered-urls-queue.gif" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-checking-submitted-urls-redisInsight-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: Verifying submitted URLs in RedisInsight
</figcaption>
</figure>
</div>
</section>
<section id="implementing-a-celery-task-for-redis-queue-processing" class="level4">
<h4 class="anchored" data-anchor-id="implementing-a-celery-task-for-redis-queue-processing"><strong>Implementing a Celery task for Redis queue processing</strong></h4>
<p>Now that we’ve replaced direct database insertion with a Redis queue, the next step is to create a Celery task that will interact with Redis to process the enqueued URLs. This task will connect to the Redis database, check the queue for any submitted URLs, and, if any are found, batch them and insert them into the PostgreSQL database.</p>
<p>To get started, we’ll create a new file named <strong>celery_app.py</strong>. This file will serve as the central place for all the code related to our Celery tasks.</p>
<p>Once the file is created, we can begin implementing our task, which we’ll divide into two main phases: First, we’ll use our Redis connection to check the queue for any enqueued URLs and retrieve them if available. Then, we’ll proceed to batch the retrieved URLs and insert them into the PostgreSQL database. This approach ensures that each part of the task is clear and manageable</p>
<section id="extracting-enqueued-urls" class="level5">
<h5 class="anchored" data-anchor-id="extracting-enqueued-urls">Extracting enqueued URLs</h5>
<p>Before we begin extracting URLs from the Redis queue, we first need to establish a connection to Redis, just as we did for our Flask application. The same steps outlined in the <a href="#sec-connecting-to-redis">Connecting to Redis</a> section can be followed to set up the Redis connection.</p>
<p>Once the connection is in place, we can move on to the process of extracting URLs from the Redis queue. To do so, we will create a function designed to retrieve a specific number of values at a time. We’ll introduce a parameter called <code>n</code> to define the maximum number of values to retrieve.</p>
<p>It is important to note that when we say “extracting” URLs from the queue, we don’t just mean retrieving the values; we also need to ensure that they are removed from the queue after extraction. This is crucial to prevent the same URLs from being reprocessed in future tasks. Unfortunately, Redis doesn’t provide a built-in function to both extract and remove multiple items from the queue in a single operation.</p>
<p>To work around this, we can combine two Redis commands: <code>LRANGE</code> and <code>LTRIM</code>.</p>
<ul>
<li><p><strong><code>LRANGE</code></strong>: This command allows us to retrieve a range of elements from the Redis list (queue). To use it, we need to specify three parameters:</p>
<ol type="1">
<li><p>The key of the list.</p></li>
<li><p>The starting index from which to begin extraction.</p></li>
<li><p>The ending index where extraction should stop.</p></li>
</ol>
<p>Redis lists maintain the order of elements, with items added according to the command used. In our case, we add URLs using <code>RPUSH</code>, which places new elements at the end of the list. As a result, the element at index 0 is always the oldest. To retrieve the <code>n</code> oldest URLs, we extract elements starting from index 0 up to <code>n-1</code>.<br>
If the queue was populated using <code>LPUSH</code>, however, the item at index 0 would be the most recent, and we would extract accordingly.</p></li>
<li><p><strong><code>LTRIM</code></strong>: This command allows us to retrieve a range of elements from the Redis list (queue), so that it will contain only the specified range of elements. To use it, we need to specify three parameters:</p>
<ol type="1">
<li><p>The key of the list.</p></li>
<li><p>The starting index from which to begin extraction.</p></li>
<li><p>The ending index where extraction should stop.</p></li>
</ol>
<p>After extracting the processed items with <code>LRANGE</code>, we will use <code>LTRIM</code> to remove them from the list. Therefore, we will trim the list to include the elements starting from index <code>n</code> (the first unprocessed item) to <code>-1</code> (the last item in the list).</p></li>
</ul>
<p>In Python, we can execute these commands, just as we did with <code>RPUSH</code>, using a Redis connection and the corresponding methods: <code>lrange</code> and <code>ltrim</code>.</p>
<p>In a multi-worker environment, there is a risk of concurrency issues when executing <code>LRANGE</code> and <code>LTRIM</code> as separate commands. Other workers might modify the queue in between these operations—either adding new URLs or removing existing ones—leading to race conditions, incorrect deletions, or data inconsistencies.</p>
<p>To prevent such issues, Redis provides <strong>pipelining</strong>, which allows multiple commands to be executed in a single batch. This ensures that commands like <code>LRANGE</code> and <code>LTRIM</code> are processed together, minimizing the risk of interference from other workers.</p>
<p>In Python, we can implement pipelining using the <code>pipeline</code> method of a Redis connection. This method creates a pipeline object that allows us to queue multiple Redis commands and execute them all at once.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Using Redis pipelines in python
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>To start using a pipeline, we first need to create a pipeline object using the <code>pipeline</code> method from the Redis client. This object will queue the commands to be executed later.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>redis_conn <span class="op">=</span> redis.Redis(host<span class="op">=</span>redis_host, port<span class="op">=</span>redis_port)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> redis_conn.pipeline()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Once the pipeline is created, we can add Redis commands to it. This is done by calling the appropriate Redis command method on the <code>pipeline</code> object, just like we would with a regular Redis command. For example, to add the <code>LRANGE</code> and <code>LPUSH</code> commands:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>pipeline.lrange(<span class="st">"url_queue"</span>, <span class="dv">0</span>, n<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>pipeline.ltrim(<span class="st">"url_queue"</span>, n, <span class="op">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Once all the commands have been added to the pipeline, we can execute them by calling the <code>execute</code> method of the pipeline.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>pipeline.execute()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<p>The result returned by the pipeline execution will be a list where:</p>
<ul>
<li><p>The first element is a list of extracted URLs (returned by <code>LRANGE</code>).</p></li>
<li><p>The second element is a boolean indicating whether <code>LTRIM</code> executed successfully.</p></li>
</ul>
<p>Using this result, we can verify if the queue was properly trimmed by checking the second element. If the trim operation was successful, it confirms that all the extracted elements were removed from the queue. In that case, we can proceed to return the list of extracted URLs (the first element). Since Redis stores strings as bytes, each URL needs to be decoded from its byte format to a regular string using the <code>.decode</code> method. If the trim operation was unsuccessful, we will return an empty list instead.</p>
<p>With all this in mind, the implementation of the <code>dequeue_urls_from_redis</code> function will look as follows:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dequeue_urls_from_redis(n: <span class="bu">int</span>) <span class="op">-&gt;</span> List[<span class="bu">str</span>]:</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Start a Redis pipeline to batch operations</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>        url_dequeue_pipeline <span class="op">=</span> redis_client.connection.pipeline()</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract the specified range of values from the queue</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        url_dequeue_pipeline.lrange(<span class="st">"url_queue"</span>, <span class="dv">0</span>, n<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Trim the queue to remove the processed values</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>        url_dequeue_pipeline.ltrim(<span class="st">"url_queue"</span>, n, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Execute the batch operations</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>        urls <span class="op">=</span> url_dequeue_pipeline.execute()</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If queue was trimmed, decode the extracted URLs from bytes to strings</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> urls[<span class="dv">1</span>]:</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>            registered_urls <span class="op">=</span> [url.decode() <span class="cf">for</span> url <span class="kw">in</span> urls[<span class="dv">0</span>]]</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>            registered_urls <span class="op">=</span> []</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> registered_urls</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"Failed to dequeue URLs from Redis: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="batching-and-storing-dequeued-urls-to-postgresql" class="level5">
<h5 class="anchored" data-anchor-id="batching-and-storing-dequeued-urls-to-postgresql">Batching and storing dequeued URLs to PostgreSQL</h5>
<p>Once we’ve connected to Redis and retrieved the URLs from the queue, the next step is to insert them into our PostgreSQL database. Specifically, we need to store these URLs in the <code>registered_urls</code> table.</p>
<p>We can reuse the <code>insert_url_into_database</code> function we previously defined in our <strong>app.py</strong>:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> insert_url_into_database(url: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>        conn <span class="op">=</span> connect_to_database()</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>        cur <span class="op">=</span> conn.cursor()</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>        cur.execute(<span class="st">"INSERT INTO registered_urls (url) VALUES (</span><span class="sc">%s</span><span class="st">)"</span>, (url,))</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        conn.commit()</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Error inserting URL into the database:"</span>, e)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>        conn.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>While this function works for inserting a single URL, it becomes inefficient when we need to process a batch of URLs. The reason for this inefficiency is that the function inserts each URL individually, which leads to multiple database interactions, increasing overhead.</p>
<p>Since we are using a queue system to avoid overwhelming the PostgreSQL database with excessive requests, inserting each URL one by one would go against this principle by adding unnecessary load to the database.</p>
<p>To address this, we need to refactor the function to support batch insertions. Instead of inserting one URL at a time, we will modify the function to accept a list of URLs. We will also switch from using <code>execute</code> to <code>executemany</code>, which allows us to execute a single query that inserts all URLs in one operation. This significantly reduces the load on the database. Additionally, we will use a list comprehension to format the URLs into a structure suitable for <code>executemany</code>. Finally, we will replace the <code>print</code> statement for errors with proper logging and we will add a log message to confirm how many URLs have been successfully inserted into the database.</p>
<p>Here is the updated version of the function:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> insert_urls_to_database(urls: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>        conn <span class="op">=</span> connect_to_database()</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>        cur <span class="op">=</span> conn.cursor()</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>        cur.executemany(<span class="st">"INSERT INTO registered_urls (url) VALUES (</span><span class="sc">%s</span><span class="st">)"</span>, [(url,) <span class="cf">for</span> url <span class="kw">in</span> urls])</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>        conn.commit()</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="ss">f"Inserted </span><span class="sc">{</span><span class="bu">len</span>(urls)<span class="sc">}</span><span class="ss"> URLs into the database."</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="st">"Error inserting into the database:"</span>, e)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>        conn.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It’s important to note that we also need to include the <code>connect_to_database</code> function along with the necessary PostgreSQL connection details into our <strong>celery_app.py</strong>, as these are required for the <code>insert_urls_to_database</code> function.</p>
</section>
<section id="using-these-functions-to-implement-a-celery-task-for-dequeuing-and-batching-submitted-urls" class="level5">
<h5 class="anchored" data-anchor-id="using-these-functions-to-implement-a-celery-task-for-dequeuing-and-batching-submitted-urls">Using these functions to implement a Celery task for dequeuing and batching submitted URLs</h5>
<p>After having created all the functions to perform our task, we can proceed to create our Celery task. Specifically, our Celery task will do the following:</p>
<ol type="1">
<li><p>Extract up to 150 URLs from the Redis queue using <code>dequeue_urls_from_redis</code>. We limit the batch size to 150 URLs for several important reasons. If the queue contains thousands of URLs and we try to process them all at once, it could overwhelm the system. This would result in high memory usage, slower processing speeds, and excessive strain on both Redis and the database. By processing the URLs in smaller batches, we can reduce the load on these systems, helping to maintain more efficient use of resources and improve overall performance.</p></li>
<li><p>Check if any URLs were retrieved.</p></li>
<li><p>If URLs are available, insert them into the PostgreSQL database using <code>insert_urls_to_database</code>.</p></li>
</ol>
<p>To implement this, we will define a function that encapsulates these steps, which we will name <code>process_queued_urls</code>. However, simply defining this function is not enough for Celery to recognize and manage it as a task.</p>
<p>In Celery, tasks are registered using the <code>@app_celery.task</code> decorator. Here, <code>app_celery</code> is our Celery application instance. By applying this decorator to our function, we are telling Celery that this function should be executed asynchronously as part of a distributed task queue.</p>
<p>Below is our complete Celery task definition:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="at">@app_celery.task</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_queued_urls() <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="st">"Started processing queued URLs."</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    dequeued_urls <span class="op">=</span> dequeue_urls_from_redis(<span class="dv">150</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dequeued_urls:</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        insert_urls_to_database(dequeued_urls)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="st">"Finished processing queued URLs."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In addition, to improve the observability, we have added log messages to track the status of the task.</p>
<p>Now that we’ve defined the task function, we need to configure it to run at regular intervals. To achieve this, we will use Celery beat, which is a scheduler. Celery Beat allows us to schedule periodic tasks, so we can automate the process of running the <code>process_queued_urls</code> function at specific times.</p>
<p>The scheduling of tasks is configured through the <code>beat_schedule</code> setting. This is a dictionary within the Celery configuration (<code>app_celery.conf.beat_schedule</code>) where we define tasks and their corresponding execution intervals. Each entry in this dictionary represents one task, and for each task, we need to specify its:</p>
<ol type="1">
<li><p><strong>Task</strong>: The task that Celery should execute periodically. It’s important to specify the full path to the task, which includes both the module (or file) name and the function name. This ensures Celery can locate and execute the task correctly.</p></li>
<li><p><strong>Schedule</strong>: The interval at which the task should run, specified in seconds.</p></li>
</ol>
<p>For our example, the task we want to run periodically is <code>process_queued_urls</code>, and we want it to execute every 5 minutes. Since this task is defined in the <code>celery_app</code> module, we specify the full path as <code>celery_app.process_queued_urls</code>. The <code>schedule</code> value will be set to 300 seconds (since 5 minutes = 300 seconds). With this in mind, we can configure the <code>beat_schedule</code> in the following way:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>app_celery.conf.beat_schedule <span class="op">=</span> {</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'dequeue-urls-every-5-mins'</span>: {</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">'task'</span>: <span class="st">'celery_app.process_queued_urls'</span>,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'schedule'</span>: <span class="fl">300.0</span>,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Below, you can expand the code to see how <strong>celery_app.py</strong> looks up to this point.</p>
<div id="726bcd90" class="cell" data-execution_count="1">
<details class="code-fold">
<summary><strong>celery_app.py</strong> up to this point</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> celery <span class="im">import</span> Celery</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> redis</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> psycopg</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch Redis connection details from environment variables</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>redis_host <span class="op">=</span> os.getenv(<span class="st">'REDIS_HOST'</span>)</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>redis_port <span class="op">=</span> os.getenv(<span class="st">'REDIS_PORT'</span>)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RedisClient:</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, host: <span class="bu">str</span>, port: <span class="bu">int</span>):</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.redis_host <span class="op">=</span> host</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.redis_port <span class="op">=</span> port</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.connection <span class="op">=</span> <span class="va">self</span>._connect()</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _connect(<span class="va">self</span>) <span class="op">-&gt;</span> redis.Redis:</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Establish a connection to Redis."""</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create a connection to the Redis server</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redis.Redis(host<span class="op">=</span><span class="va">self</span>.redis_host, port<span class="op">=</span><span class="va">self</span>.redis_port)</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> redis.<span class="pp">ConnectionError</span> <span class="im">as</span> e:</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>            logging.error(<span class="ss">f"Failed to connect to Redis: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>redis_client <span class="op">=</span> RedisClient(redis_host, <span class="bu">int</span>(redis_port))</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch PostgreSQL connection details from environment variables</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>db_user <span class="op">=</span> os.getenv(<span class="st">'DB_USER'</span>)</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>db_password <span class="op">=</span> os.getenv(<span class="st">'DB_PASSWORD'</span>)</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>db_host <span class="op">=</span> os.getenv(<span class="st">'DB_HOST'</span>)</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>db_port <span class="op">=</span> os.getenv(<span class="st">'DB_PORT'</span>)</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>db_name <span class="op">=</span> os.getenv(<span class="st">'DB_NAME'</span>)</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> connect_to_database() <span class="op">-&gt;</span> psycopg.Connection <span class="op">|</span> <span class="va">None</span>:</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>        conn <span class="op">=</span> psycopg.<span class="ex">connect</span>(</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>            dbname<span class="op">=</span>db_name,</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>            user<span class="op">=</span>db_user,</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>            password<span class="op">=</span>db_password,</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>            host<span class="op">=</span>db_host,</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>            port<span class="op">=</span>db_port</span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> conn</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(e)</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the Celery application and configure it to use Redis as the broker</span></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>app_celery <span class="op">=</span> Celery(broker<span class="op">=</span><span class="ss">f"redis://</span><span class="sc">{</span>redis_host<span class="sc">}</span><span class="ss">:</span><span class="sc">{</span>redis_port<span class="sc">}</span><span class="ss">/0"</span>)</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>app_celery.conf.beat_schedule <span class="op">=</span> {</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">'dequeue-urls-every-5-mins'</span>: {</span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">'task'</span>: <span class="st">'celery_app.process_queued_urls'</span>,</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>        <span class="st">'schedule'</span>: <span class="fl">300.0</span>,</span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dequeue_urls_from_redis(n: <span class="bu">int</span>) <span class="op">-&gt;</span> List[<span class="bu">str</span>]:</span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Start a Redis pipeline to batch operations</span></span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>        url_dequeue_pipeline <span class="op">=</span> redis_client.connection.pipeline()</span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract the specified range of values from the queue</span></span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>        url_dequeue_pipeline.lrange(<span class="st">"url_queue"</span>, <span class="dv">0</span>, n<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Trim the queue to remove the processed values</span></span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>        url_dequeue_pipeline.ltrim(<span class="st">"url_queue"</span>, n, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Execute the batch operations</span></span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a>        urls <span class="op">=</span> url_dequeue_pipeline.execute()</span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If queue was trimmed, decode the extracted URLs from bytes to strings</span></span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> urls[<span class="dv">1</span>]:</span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a>            registered_urls <span class="op">=</span> [url.decode() <span class="cf">for</span> url <span class="kw">in</span> urls[<span class="dv">0</span>]]</span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a>            registered_urls <span class="op">=</span> []</span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> registered_urls</span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Handle potential errors</span></span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"Failed to dequeue URLs from Redis: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> insert_urls_to_database(urls: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>        conn <span class="op">=</span> connect_to_database()</span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a>        cur <span class="op">=</span> conn.cursor()</span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a>        cur.executemany(<span class="st">"INSERT INTO registered_urls (url) VALUES (</span><span class="sc">%s</span><span class="st">)"</span>, [(url,) <span class="cf">for</span> url <span class="kw">in</span> urls])</span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a>        conn.commit()</span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Error inserting into the database:"</span>, e)</span>
<span id="cb25-96"><a href="#cb25-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb25-97"><a href="#cb25-97" aria-hidden="true" tabindex="-1"></a>        conn.close()</span>
<span id="cb25-98"><a href="#cb25-98" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-99"><a href="#cb25-99" aria-hidden="true" tabindex="-1"></a><span class="at">@app_celery.task</span></span>
<span id="cb25-100"><a href="#cb25-100" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_queued_urls() <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb25-101"><a href="#cb25-101" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="st">'Started processing queued URLs.'</span>)</span>
<span id="cb25-102"><a href="#cb25-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-103"><a href="#cb25-103" aria-hidden="true" tabindex="-1"></a>    dequeued_urls <span class="op">=</span> dequeue_urls_from_redis(<span class="dv">150</span>)</span>
<span id="cb25-104"><a href="#cb25-104" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-105"><a href="#cb25-105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dequeued_urls:</span>
<span id="cb25-106"><a href="#cb25-106" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="ss">f'Retrieved </span><span class="sc">{</span><span class="bu">len</span>(dequeued_urls)<span class="sc">}</span><span class="ss"> URLs from Redis.'</span>)</span>
<span id="cb25-107"><a href="#cb25-107" aria-hidden="true" tabindex="-1"></a>        insert_urls_to_database(dequeued_urls)</span>
<span id="cb25-108"><a href="#cb25-108" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="ss">f'Inserted dequeued URLs into the PostgreSQL database.'</span>)</span>
<span id="cb25-109"><a href="#cb25-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb25-110"><a href="#cb25-110" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="st">'No URLs retrieved from Redis.'</span>)</span>
<span id="cb25-111"><a href="#cb25-111" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-112"><a href="#cb25-112" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="st">'Finished processing queued URLs.'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="executing-celery-tasks" class="level5">
<h5 class="anchored" data-anchor-id="executing-celery-tasks">Executing Celery tasks</h5>
<p>Now that we have set up Celery and created our task, we can move forward with executing it to be sure all works as expected.</p>
<p>Celery tasks are executed by a worker, a process that listens for incoming tasks and runs them when triggered. In our case, the worker will listen for the <code>process_queued_urls</code> task.</p>
<p>To start the Celery worker, we need to run the following command in a terminal from the directory where <strong>celery_app.py</strong> is located:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="ex">celery</span> <span class="at">-A</span> celery_app worker <span class="at">--loglevel</span><span class="op">=</span>info</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This command is made up of several parts that work together. First, <code>celery</code> is the command-line tool used to interact with Celery. The <code>-A celery_app</code> flag specifies which application to use, in this case, the <code>celery_app</code> module where we’ve defined our Celery app. By adding <code>worker</code>, we indicate that we want to start the worker process, which listens for and executes tasks when they’re triggered. The <code>--loglevel=info</code> flag sets the logging level to “info,” providing detailed output in the terminal to track the worker’s activities.</p>
<p>In addition to the Celery worker, we also need to start Celery Beat as we’ve configured a periodic task <code>process_queued_urls</code> to run every 5 minutes (300 seconds) in the <code>beat_schedule</code> of <code>celery_app.py</code>. Celery Beat will ensure that the periodic task is executed according to the schedule.</p>
<p>This is done by running the following command in a separate terminal window from the same directory:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ex">celery</span> <span class="at">-A</span> celery_app beat <span class="at">--loglevel</span><span class="op">=</span>info</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Like the worker command, this also uses <code>-A celery_app</code> to specify the application, but here we use <code>beat</code> instead of <code>worker</code> to indicate that we want to start the Celery Beat process. This will manage our periodic tasks. The <code>--loglevel=info</code> flag again ensures that we see detailed logging information in the terminal, so we can monitor what’s happening.</p>
<p><a href="#fig-celery-first-start-dequeue-task" class="quarto-xref">Figure&nbsp;12</a> shows the execution of both the Celery worker and Celery Beat. The left terminal window shows the output of the command <code>celery -A celery_app worker --loglevel=info</code>, indicating that the Celery worker is running and ready to process tasks. The right terminal window displays the output of the command <code>celery -A celery_app beat --loglevel=info</code>, showing that Celery Beat is active and scheduling the periodic task <code>process_queued_urls</code> according to the defined schedule.</p>
<div id="fig-celery-first-start-dequeue-task" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-celery-first-start-dequeue-task-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="assets/celery-first-start-dequeue-task.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-celery-first-start-dequeue-task-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12: Starting Celery worker and scheduler for task execution
</figcaption>
</figure>
</div>
<p>Once both the Celery worker and Celery Beat are running, the <code>process_queued_urls</code> task will be executed every 5 minutes as configured, and the worker will process any incoming tasks.</p>
<p>In <a href="#fig-dequeue-task-changes-redis-and-db" class="quarto-xref">Figure&nbsp;13</a>, we can see a side-by-side view of the graphical interfaces for both our PostgreSQL database (on the left) and our Redis database (on the right). Initially, the <code>registered_urls</code> table in PostgreSQL contains three URLs: <em>www.google.com</em>, <em>www.facebook.com</em>, and <em>www.google.com</em>. At the same time, in Redis, the queue with the key <code>url_queue</code> holds two URLs: <em>www.google.com</em>, and <em>www.facebook.com</em>.</p>
<p>When the <code>process_queued_urls</code> task is triggered, as shown in the red-highlighted section of the terminal, the task processes the URLs in Redis. After this, if we refresh the Redis database, the <code>url_queue</code> key disappears because all the URLs in the queue have been dequeued and inserted into the <code>registered_urls</code> table in PostgreSQL. After refreshing the PostgreSQL database, we now see that it contains five URLs instead of the original three, including the URLs that were previously in the Redis queue.</p>
<div id="fig-dequeue-task-changes-redis-and-db" class="lightbox quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dequeue-task-changes-redis-and-db-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="assets/worker-running-dequeue.gif" class="lightbox" data-gallery="quarto-lightbox-gallery-12" title="Figure&nbsp;13: Watching Redis Queue Empty as URLs Are Moved to PostgreSQL"><img src="assets/worker-running-dequeue.gif" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dequeue-task-changes-redis-and-db-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13: Watching Redis Queue Empty as URLs Are Moved to PostgreSQL
</figcaption>
</figure>
</div>
</section>
</section>
</section>
<section id="improving-the-top-favorite-websites-page" class="level3">
<h3 class="anchored" data-anchor-id="improving-the-top-favorite-websites-page">Improving the Top Favorite Websites page</h3>
<p>Having implemented the improvements for the Home page, we now proceed to optimize the <em>Top Favorite Websites</em> page. As previously discussed, the goal is to move away from querying the PostgreSQL database in real time and instead precompute and cache the results for the top ten favorite websites.</p>
<p>To implement this change, we will begin by creating a Celery task that will run periodically to compute and cache the top ten favorite websites. Once this caching system is in place, we will update the Flask application to fetch the data from Redis, bypassing the need to query PostgreSQL for each user request.</p>
<section id="creating-a-celery-task-to-cache-the-top-ten-favorite-websites" class="level4">
<h4 class="anchored" data-anchor-id="creating-a-celery-task-to-cache-the-top-ten-favorite-websites"><strong>Creating a Celery task to cache the top ten favorite websites</strong></h4>
<p>The first step in this process is to set up the cache. We’ll create a Celery task that will execute every thirty minutes. This task will perform two main actions. First, it will connect to the PostgreSQL database to count the occurrences of each submitted URL, sort these counts in descending order, and identify the top ten most frequent URLs. Next, the task will store these results in Redis to ensure fast and efficient access for future requests.</p>
<section id="extracting-the-top-ten-favorite-websites-from-our-postgresql" class="level5">
<h5 class="anchored" data-anchor-id="extracting-the-top-ten-favorite-websites-from-our-postgresql">Extracting the top ten favorite websites from our PostgreSQL</h5>
<p>Currently, the process of extracting the top ten favorite websites from the PostgreSQL database is already implemented in our Flask application through the <code>get_top_registered_urls</code> function. This function connects to the database and queries it to retrieve the top favorite websites.</p>
<p>To recap, below is the existing implementation:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_top_registered_urls() <span class="op">-&gt;</span> List[Tuple[<span class="bu">str</span>, <span class="bu">int</span>]] <span class="op">|</span> <span class="va">None</span>:</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>        conn <span class="op">=</span> connect_to_database()</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>        cur <span class="op">=</span> conn.cursor()</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>        cur.execute(<span class="st">"""</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="st">            SELECT url, COUNT(*) as count</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="st">            FROM registered_urls</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="st">            GROUP BY url</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="st">            ORDER BY count DESC</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="st">            LIMIT 10;</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span>)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>        top_registered_urls <span class="op">=</span> cur.fetchall()</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> top_registered_urls</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error retrieving the URLs: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> conn:</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>            conn.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Since we are transitioning to a background caching strategy, we will move this function from the Flask application (<strong>app.py</strong>) to the Celery application (<strong>celery_app.py</strong>).</p>
</section>
<section id="caching-the-top-ten-favorite-websites-into-redis" class="level5">
<h5 class="anchored" data-anchor-id="caching-the-top-ten-favorite-websites-into-redis">Caching the top ten favorite websites into Redis</h5>
<p>After extracting the top ten favorite websites from PostgreSQL, we need to store them in our Redis cache. To achieve this, we will create a function called <code>save_popular_to_redis</code>, which will take the output of <code>get_top_registered_urls</code> as its only argument, and it store it in Redis.</p>
<p>Since <code>get_top_registered_urls</code> returns a list of tuples containing URLs and their respective counts (e.g., <code>[('www.google.com', 4), ('www.facebook.com', 4), ('www.test.com', 1)]</code>), we first need to convert this structure into a dictionary.</p>
<p>Before storing this data in Redis, we must first convert it into a dictionary. This is necessary because Redis supports different data structures, and for our use case, a <strong>hash</strong> (or <strong>hashmap</strong>) is the most appropriate. Hashes in Redis allow us to store multiple field-value pairs under a single Redis key, making it easy to retrieve and manipulate individual entries. In this case we will store the URLs and counts as field-value pairs</p>
<p>To store this dictionary in Redis, we will use the <code>HSET</code> command, which sets multiple fields and values in a hash stored at a specific key. If the specified key does not exist, Redis will automatically create a new hash. If the key already exists, the <code>HSET</code> command will update the fields within the hash, leaving any fields that are not included in the update unchanged.</p>
<p>To perform this operation, we will reuse the Redis connection we created earlier. We will call the <code>hset</code> method with two parameters: the key name (in this case, <code>"top_favorite_websites"</code>) and the dictionary containing the URLs and their corresponding counts.</p>
<p>When using the <code>HSET</code> command to store the data, it is important to understand its behavior: <code>HSET</code> updates only the fields that are included in the data provided. If any field in the hash already exists but is not included in the update, it will not be modified and will remain in the hash. This means that fields which are not updated will persist, even if they no longer need to be in the hash.</p>
<p>However, in our case, we do <strong>not</strong> want to retain any previous data that’s not part of the updated dictionary of URLs and counts. To ensure that only the current top ten favorite websites are stored, we must delete the existing Redis key (if it exists) before calling <code>HSET</code>. This can be done using the <code>delete</code> method of our Redis connection, which will remove the old data and ensure that only the new data is stored.</p>
<p>Below is the function implementation:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_popular_to_redis(registered_urls: List[Tuple[<span class="bu">str</span>, <span class="bu">int</span>]]):</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>        registered_urls_dict <span class="op">=</span> <span class="bu">dict</span>(registered_urls)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        redis_client.connection.delete(<span class="st">"top_favorite_websites"</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>        redis_client.connection.hset(<span class="st">"top_favorite_websites"</span>, mapping<span class="op">=</span>registered_urls_dict)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="st">"Successfully cached top favorite websites in Redis."</span>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"Error when caching top favorite websites: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="using-these-functions-to-implement-a-celery-task-for-caching-top-favorite-websites" class="level5">
<h5 class="anchored" data-anchor-id="using-these-functions-to-implement-a-celery-task-for-caching-top-favorite-websites"><strong>Using these functions to implement a Celery task for caching top favorite websites</strong></h5>
<p>Once we have implemented the necessary functions, we can proceed with creating a Celery task to automate the caching of the top favorite websites. The Celery task will perform the following steps:</p>
<ol type="1">
<li><p>Retrieve the top ten most popular websites from the PostgreSQL database using the <code>get_top_registered_urls</code> function.</p></li>
<li><p>Store the retrieved websites in Redis using the <code>save_popular_to_redis</code> function.</p></li>
</ol>
<p>To achieve this, we define a Celery task named <code>cache_top_favorite_websites</code>, which encapsulates these steps:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="at">@app_celery.task</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cache_top_favorite_websites() <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="st">"Started caching top favorite websites."</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    top_urls <span class="op">=</span> get_top_registered_urls()</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> top_urls:</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="ss">f"Retrieved top URLs from PostgreSQL."</span>)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>        save_popular_to_redis(top_urls)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="st">"Successfully cached top favorite websites."</span>)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="st">"No URLs retrieved from PostgreSQL, skipping caching."</span>)</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="st">"Finished caching process."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Just like the previous task we created, we want this task to periodically, i.e., every 30 minutes. To accomplish this, we need to add it to the Celery <strong>beat schedule</strong> so that it executes every 30 minutes (1800 seconds).</p>
<p>Here’s the updated beat schedule configuration:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>app_celery.conf.beat_schedule <span class="op">=</span> {</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cache-top-favorite-websites-every-30-mins'</span>: {</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">'task'</span>: <span class="st">'celery_app.cache_top_favorite_websites'</span>,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'schedule'</span>: <span class="fl">1800.0</span>,  <span class="co"># 30 minutes</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'dequeue-urls-every-5-mins'</span>: {</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'task'</span>: <span class="st">'celery_app.process_queued_urls'</span>,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'schedule'</span>: <span class="fl">300.0</span>,  <span class="co"># 5 minutes</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To see how all these pieces fit together, you can unfold the code below for the full <strong>celery_app.py</strong> file.</p>
<div id="fbc78a5d" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>full <strong>celery_app.py</strong></summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> celery <span class="im">import</span> Celery</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> redis</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> psycopg</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>logging.basicConfig(level<span class="op">=</span>logging.INFO)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch Redis connection details from environment variables</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>redis_host <span class="op">=</span> os.getenv(<span class="st">'REDIS_HOST'</span>)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>redis_port <span class="op">=</span> os.getenv(<span class="st">'REDIS_PORT'</span>)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RedisClient:</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, host: <span class="bu">str</span>, port: <span class="bu">int</span>):</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.redis_host <span class="op">=</span> host</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.redis_port <span class="op">=</span> port</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.connection <span class="op">=</span> <span class="va">self</span>._connect()</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _connect(<span class="va">self</span>) <span class="op">-&gt;</span> redis.Redis:</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Establish a connection to Redis."""</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create a connection to the Redis server</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redis.Redis(host<span class="op">=</span><span class="va">self</span>.redis_host, port<span class="op">=</span><span class="va">self</span>.redis_port)</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> redis.<span class="pp">ConnectionError</span> <span class="im">as</span> e:</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>            logging.error(<span class="ss">f"Failed to connect to Redis: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>redis_client <span class="op">=</span> RedisClient(redis_host, <span class="bu">int</span>(redis_port))</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch PostgreSQL connection details from environment variables</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>db_user <span class="op">=</span> os.getenv(<span class="st">'DB_USER'</span>)</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>db_password <span class="op">=</span> os.getenv(<span class="st">'DB_PASSWORD'</span>)</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>db_host <span class="op">=</span> os.getenv(<span class="st">'DB_HOST'</span>)</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>db_port <span class="op">=</span> os.getenv(<span class="st">'DB_PORT'</span>)</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>db_name <span class="op">=</span> os.getenv(<span class="st">'DB_NAME'</span>)</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> connect_to_database() <span class="op">-&gt;</span> psycopg.Connection <span class="op">|</span> <span class="va">None</span>:</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>        conn <span class="op">=</span> psycopg.<span class="ex">connect</span>(</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>            dbname<span class="op">=</span>db_name,</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>            user<span class="op">=</span>db_user,</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>            password<span class="op">=</span>db_password,</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>            host<span class="op">=</span>db_host,</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>            port<span class="op">=</span>db_port</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> conn</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"Database connection failed: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the Celery application and configure it to use Redis as the broker</span></span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>app_celery <span class="op">=</span> Celery(broker<span class="op">=</span><span class="ss">f"redis://</span><span class="sc">{</span>redis_host<span class="sc">}</span><span class="ss">:</span><span class="sc">{</span>redis_port<span class="sc">}</span><span class="ss">/0"</span>)</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>app_celery.conf.beat_schedule <span class="op">=</span> {</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cache-top-favorite-websites-every-30-mins'</span>: {</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">'task'</span>: <span class="st">'celery_app.cache_top_favorite_websites'</span>,</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">'schedule'</span>: <span class="fl">1800.0</span>,  <span class="co"># 30 minutes</span></span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>    <span class="st">'dequeue-urls-every-5-mins'</span>: {</span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">'task'</span>: <span class="st">'celery_app.process_queued_urls'</span>,</span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a>        <span class="st">'schedule'</span>: <span class="fl">300.0</span>,  <span class="co"># 5 minutes</span></span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dequeue_urls_from_redis(n: <span class="bu">int</span>) <span class="op">-&gt;</span> List[<span class="bu">str</span>]:</span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Start a Redis pipeline to batch operations</span></span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>        url_dequeue_pipeline <span class="op">=</span> redis_client.connection.pipeline()</span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract the specified range of values from the queue</span></span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>        url_dequeue_pipeline.lrange(<span class="st">"url_queue"</span>, <span class="dv">0</span>, n<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Trim the queue to remove the processed values</span></span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>        url_dequeue_pipeline.ltrim(<span class="st">"url_queue"</span>, n, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Execute the batch operations</span></span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a>        urls <span class="op">=</span> url_dequeue_pipeline.execute()</span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If queue was trimmed, decode the extracted URLs from bytes to strings</span></span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> urls[<span class="dv">1</span>]:</span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a>            registered_urls <span class="op">=</span> [url.decode() <span class="cf">for</span> url <span class="kw">in</span> urls[<span class="dv">0</span>]]</span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a>            registered_urls <span class="op">=</span> []</span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> registered_urls</span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Handle potential errors</span></span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"Failed to dequeue URLs from Redis: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> insert_urls_to_database(urls: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a>        conn <span class="op">=</span> connect_to_database()</span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a>        cur <span class="op">=</span> conn.cursor()</span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a>        cur.executemany(<span class="st">"INSERT INTO registered_urls (url) VALUES (</span><span class="sc">%s</span><span class="st">)"</span>, [(url,) <span class="cf">for</span> url <span class="kw">in</span> urls])</span>
<span id="cb32-99"><a href="#cb32-99" aria-hidden="true" tabindex="-1"></a>        conn.commit()</span>
<span id="cb32-100"><a href="#cb32-100" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="ss">f"Inserted </span><span class="sc">{</span><span class="bu">len</span>(urls)<span class="sc">}</span><span class="ss"> URLs into the database."</span>)</span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"Error inserting into the database: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a>        conn.close()</span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_top_registered_urls() <span class="op">-&gt;</span> List[Tuple[<span class="bu">str</span>, <span class="bu">int</span>]] <span class="op">|</span> <span class="va">None</span>:</span>
<span id="cb32-107"><a href="#cb32-107" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb32-108"><a href="#cb32-108" aria-hidden="true" tabindex="-1"></a>        conn <span class="op">=</span> connect_to_database()</span>
<span id="cb32-109"><a href="#cb32-109" aria-hidden="true" tabindex="-1"></a>        cur <span class="op">=</span> conn.cursor()</span>
<span id="cb32-110"><a href="#cb32-110" aria-hidden="true" tabindex="-1"></a>        cur.execute(<span class="st">"""</span></span>
<span id="cb32-111"><a href="#cb32-111" aria-hidden="true" tabindex="-1"></a><span class="st">            SELECT url, COUNT(*) as count</span></span>
<span id="cb32-112"><a href="#cb32-112" aria-hidden="true" tabindex="-1"></a><span class="st">            FROM registered_urls</span></span>
<span id="cb32-113"><a href="#cb32-113" aria-hidden="true" tabindex="-1"></a><span class="st">            GROUP BY url</span></span>
<span id="cb32-114"><a href="#cb32-114" aria-hidden="true" tabindex="-1"></a><span class="st">            ORDER BY count DESC</span></span>
<span id="cb32-115"><a href="#cb32-115" aria-hidden="true" tabindex="-1"></a><span class="st">            LIMIT 10;</span></span>
<span id="cb32-116"><a href="#cb32-116" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span>)</span>
<span id="cb32-117"><a href="#cb32-117" aria-hidden="true" tabindex="-1"></a>        top_registered_urls <span class="op">=</span> cur.fetchall()</span>
<span id="cb32-118"><a href="#cb32-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> top_registered_urls</span>
<span id="cb32-119"><a href="#cb32-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb32-120"><a href="#cb32-120" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error retrieving the URLs: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-121"><a href="#cb32-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb32-122"><a href="#cb32-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> conn:</span>
<span id="cb32-123"><a href="#cb32-123" aria-hidden="true" tabindex="-1"></a>            conn.close()</span>
<span id="cb32-124"><a href="#cb32-124" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb32-125"><a href="#cb32-125" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_popular_to_redis(registered_urls: List[Tuple[<span class="bu">str</span>, <span class="bu">int</span>]]):</span>
<span id="cb32-126"><a href="#cb32-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb32-127"><a href="#cb32-127" aria-hidden="true" tabindex="-1"></a>        registered_urls_dict <span class="op">=</span> <span class="bu">dict</span>(registered_urls)</span>
<span id="cb32-128"><a href="#cb32-128" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-129"><a href="#cb32-129" aria-hidden="true" tabindex="-1"></a>        redis_client.connection.delete(<span class="st">"top_favorite_websites"</span>)</span>
<span id="cb32-130"><a href="#cb32-130" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-131"><a href="#cb32-131" aria-hidden="true" tabindex="-1"></a>        redis_client.connection.hset(<span class="st">"top_favorite_websites"</span>, mapping<span class="op">=</span>registered_urls_dict)</span>
<span id="cb32-132"><a href="#cb32-132" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-133"><a href="#cb32-133" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="st">"Successfully cached top favorite websites in Redis."</span>)</span>
<span id="cb32-134"><a href="#cb32-134" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb32-135"><a href="#cb32-135" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"Error when caching top favorite websites: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-136"><a href="#cb32-136" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-137"><a href="#cb32-137" aria-hidden="true" tabindex="-1"></a><span class="at">@app_celery.task</span></span>
<span id="cb32-138"><a href="#cb32-138" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_queued_urls() <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb32-139"><a href="#cb32-139" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="st">'Started processing queued URLs.'</span>)</span>
<span id="cb32-140"><a href="#cb32-140" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-141"><a href="#cb32-141" aria-hidden="true" tabindex="-1"></a>    dequeued_urls <span class="op">=</span> dequeue_urls_from_redis(<span class="dv">150</span>)</span>
<span id="cb32-142"><a href="#cb32-142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-143"><a href="#cb32-143" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dequeued_urls:</span>
<span id="cb32-144"><a href="#cb32-144" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="ss">f'Retrieved </span><span class="sc">{</span><span class="bu">len</span>(dequeued_urls)<span class="sc">}</span><span class="ss"> URLs from Redis.'</span>)</span>
<span id="cb32-145"><a href="#cb32-145" aria-hidden="true" tabindex="-1"></a>        insert_urls_to_database(dequeued_urls)</span>
<span id="cb32-146"><a href="#cb32-146" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="ss">f'Inserted dequeued URLs into the PostgreSQL database.'</span>)</span>
<span id="cb32-147"><a href="#cb32-147" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb32-148"><a href="#cb32-148" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="st">'No URLs retrieved from Redis.'</span>)</span>
<span id="cb32-149"><a href="#cb32-149" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-150"><a href="#cb32-150" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="st">'Finished processing queued URLs.'</span>)</span>
<span id="cb32-151"><a href="#cb32-151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-152"><a href="#cb32-152" aria-hidden="true" tabindex="-1"></a><span class="at">@app_celery.task</span></span>
<span id="cb32-153"><a href="#cb32-153" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cache_top_favorite_websites() <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb32-154"><a href="#cb32-154" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="st">"Started caching top favorite websites."</span>)</span>
<span id="cb32-155"><a href="#cb32-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-156"><a href="#cb32-156" aria-hidden="true" tabindex="-1"></a>    top_urls <span class="op">=</span> get_top_registered_urls()</span>
<span id="cb32-157"><a href="#cb32-157" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-158"><a href="#cb32-158" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> top_urls:</span>
<span id="cb32-159"><a href="#cb32-159" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="ss">f"Retrieved top URLs from PostgreSQL."</span>)</span>
<span id="cb32-160"><a href="#cb32-160" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-161"><a href="#cb32-161" aria-hidden="true" tabindex="-1"></a>        save_popular_to_redis(top_urls)</span>
<span id="cb32-162"><a href="#cb32-162" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="st">"Successfully cached top favorite websites."</span>)</span>
<span id="cb32-163"><a href="#cb32-163" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb32-164"><a href="#cb32-164" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="st">"No URLs retrieved from PostgreSQL, skipping caching."</span>)</span>
<span id="cb32-165"><a href="#cb32-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-166"><a href="#cb32-166" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="st">"Finished caching process."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We are now ready to test the newly implemented task. To do this, we need to restart both the Celery worker and Celery Beat. If they are still running from the previous session, we should stop them first. Afterward, we can restart them by executing the following commands in two separate terminal windows. In the first terminal, navigate to the directory where <strong>celery_app.py</strong> is located and run <code>celery -A celery_app worker --loglevel=info</code>. Then, in the second terminal, run <code>celery -A celery_app beat --loglevel=info</code>. This will restart both components and prepare them for testing.</p>
<p>After 30 minutes, once the <code>cache_top_favorite_websites</code> task has finished running, we can use RedisInsight to check the Redis database. As shown in <a href="#fig-top-favorite-websites-key-redisInsight" class="quarto-xref">Figure&nbsp;14</a>, we will find a new key named <code>top_favorite_websites</code>. Clicking on this key will display its contents in the right panel of RedisInsight. Specifically, it will show a Hash, which contains the data for the top favorite websites. In this case, we will see two URLs: <em>www.google.com</em> with a count of 3, and <em>www.facebook.com</em> with a count of 2, as we have registered only two unique URLs.</p>
<div id="fig-top-favorite-websites-key-redisInsight" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-top-favorite-websites-key-redisInsight-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="assets/redis-cached-top-favorite-websites.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-top-favorite-websites-key-redisInsight-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;14: Viewing the <code>top_favorite_websites</code> Key in RedisInsight
</figcaption>
</figure>
</div>
</section>
</section>
<section id="replacing-direct-database-queries-with-redis-cache-retrieval" class="level4">
<h4 class="anchored" data-anchor-id="replacing-direct-database-queries-with-redis-cache-retrieval">Replacing direct database queries with Redis cache retrieval</h4>
<p>Now, we have a cached version of our popular URLs table. Therefore, we need to modify our code in <strong>app.py</strong> so that it no longer retrieves the popular URLs table from our PostgreSQL database, but instead fetches it from our Redis cache.</p>
<p>we’ll create a function called <code>retrieve_favorite_websites_from_redis</code>. This function will be responsible for retrieving all the key-value pairs stored in the Hash under the <code>top_favorite_websites</code> key in Redis. We can easily achieve this by using Redis’s <code>HGETALL</code> command, which fetches all key-value pairs from a specific hash in Redis. We only need to provide the key (in this case, <code>top_favorite_websites</code>) where the hash is stored, and Redis will return the entire hash.</p>
<p>In Python, we can execute this by calling the <code>hgetall</code> method on a Redis connection object. This will return the key-value pairs in the form of a Python dictionary. Since we originally represented the table as a list of tuples, we will then convert this dictionary into a list of tuples for easier handling in our code.</p>
<p>Below is the resulting code to implement this:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> retrieve_favorite_websites_from_redis() <span class="op">-&gt;</span> List[Tuple[<span class="bu">str</span>, <span class="bu">int</span>]] <span class="op">|</span> <span class="va">None</span>:</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>        favorite_websites <span class="op">=</span> redis_client.connection.hgetall(<span class="st">"top_favorite_websites"</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>        favorite_websites <span class="op">=</span> [(url.decode(), <span class="bu">int</span>(count)) <span class="cf">for</span> url, count <span class="kw">in</span> favorite_websites.items()]</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> favorite_websites</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"Error retrieving favorite websites from Redis: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now, we just need to call this function each time a user visits the <em>Top Favorite Websites</em> page, instead of calling <code>get_top_registered_urls</code> as we did before.</p>
<p>After applying these changes, you can see how the <strong>app.py</strong> file would look by unfolding the code below.</p>
<div id="2d277f12" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>updated <strong>app.py</strong></summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> Flask, request, render_template, redirect, url_for</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> psycopg</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re </span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> redis</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>logging.basicConfig(level<span class="op">=</span>logging.INFO)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>db_user <span class="op">=</span> os.getenv(<span class="st">'DB_USER'</span>)</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>db_password <span class="op">=</span> os.getenv(<span class="st">'DB_PASSWORD'</span>)</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>db_host <span class="op">=</span> os.getenv(<span class="st">'DB_HOST'</span>)</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>db_port <span class="op">=</span> os.getenv(<span class="st">'DB_PORT'</span>)</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>db_name <span class="op">=</span> os.getenv(<span class="st">'DB_NAME'</span>)</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>redis_host <span class="op">=</span> os.getenv(<span class="st">'REDIS_HOST'</span>)</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>redis_port <span class="op">=</span> os.getenv(<span class="st">'REDIS_PORT'</span>)</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RedisClient:</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, host: <span class="bu">str</span>, port: <span class="bu">int</span>):</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.redis_host <span class="op">=</span> host</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.redis_port <span class="op">=</span> port</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.connection <span class="op">=</span> <span class="va">self</span>._connect()</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _connect(<span class="va">self</span>) <span class="op">-&gt;</span> redis.Redis:</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Establish a connection to Redis."""</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create a connection to the Redis server</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redis.Redis(host<span class="op">=</span><span class="va">self</span>.redis_host, port<span class="op">=</span><span class="va">self</span>.redis_port)</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> redis.<span class="pp">ConnectionError</span> <span class="im">as</span> e:</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>            logging.error(<span class="ss">f"Failed to connect to Redis: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>redis_client <span class="op">=</span> RedisClient(redis_host, <span class="bu">int</span>(redis_port))</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> connect_to_database() <span class="op">-&gt;</span> psycopg.Connection <span class="op">|</span> <span class="va">None</span>:</span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>        conn <span class="op">=</span> psycopg.<span class="ex">connect</span>(</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>            dbname<span class="op">=</span>db_name,</span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>            user<span class="op">=</span>db_user,</span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>            password<span class="op">=</span>db_password,</span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>            host<span class="op">=</span>db_host,</span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>            port<span class="op">=</span>db_port</span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> conn</span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"Database connection failed: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_valid_url(url: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a>    pattern <span class="op">=</span> <span class="vs">r"^(https?:\/\/)?(www\.)?[a-zA-Z0-9]+\.[a-zA-Z]+$"</span></span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">bool</span>(re.fullmatch(pattern, url))</span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> enqueue_url_to_redis(url: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Push the URL to a Redis queue (list)</span></span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a>        redis_client.connection.lpush(<span class="st">"url_queue"</span>, url)</span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true" tabindex="-1"></a>        logging.debug(<span class="ss">f"URL enqueued to Redis: </span><span class="sc">{</span>url<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-60"><a href="#cb34-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb34-61"><a href="#cb34-61" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"Error sending URL to Redis queue: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-62"><a href="#cb34-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-63"><a href="#cb34-63" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_url(url: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb34-64"><a href="#cb34-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_valid_url(url):</span>
<span id="cb34-65"><a href="#cb34-65" aria-hidden="true" tabindex="-1"></a>        enqueue_url_to_redis(url)</span>
<span id="cb34-66"><a href="#cb34-66" aria-hidden="true" tabindex="-1"></a>        confirmation_message <span class="op">=</span> <span class="st">"You have successfully registered the following URL: "</span> <span class="op">+</span> url</span>
<span id="cb34-67"><a href="#cb34-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb34-68"><a href="#cb34-68" aria-hidden="true" tabindex="-1"></a>        confirmation_message <span class="op">=</span> <span class="st">"The URL you entered is not valid. Please check the format and try again."</span></span>
<span id="cb34-69"><a href="#cb34-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> confirmation_message</span>
<span id="cb34-70"><a href="#cb34-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-71"><a href="#cb34-71" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> retrieve_favorite_websites_from_redis() <span class="op">-&gt;</span> List[Tuple[<span class="bu">str</span>, <span class="bu">int</span>]] <span class="op">|</span> <span class="va">None</span>:</span>
<span id="cb34-72"><a href="#cb34-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb34-73"><a href="#cb34-73" aria-hidden="true" tabindex="-1"></a>        favorite_websites <span class="op">=</span> redis_client.connection.hgetall(<span class="st">"top_favorite_websites"</span>)</span>
<span id="cb34-74"><a href="#cb34-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-75"><a href="#cb34-75" aria-hidden="true" tabindex="-1"></a>        favorite_websites <span class="op">=</span> [(url.decode(), <span class="bu">int</span>(count)) <span class="cf">for</span> url, count <span class="kw">in</span> favorite_websites.items()]</span>
<span id="cb34-76"><a href="#cb34-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-77"><a href="#cb34-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> favorite_websites</span>
<span id="cb34-78"><a href="#cb34-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb34-79"><a href="#cb34-79" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"Error retrieving favorite websites from Redis: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-80"><a href="#cb34-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-81"><a href="#cb34-81" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> Flask(<span class="va">__name__</span>)</span>
<span id="cb34-82"><a href="#cb34-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-83"><a href="#cb34-83" aria-hidden="true" tabindex="-1"></a><span class="at">@app.cli.command</span>(<span class="st">"init-db-table"</span>)</span>
<span id="cb34-84"><a href="#cb34-84" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_table() <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb34-85"><a href="#cb34-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb34-86"><a href="#cb34-86" aria-hidden="true" tabindex="-1"></a>        conn <span class="op">=</span> connect_to_database()</span>
<span id="cb34-87"><a href="#cb34-87" aria-hidden="true" tabindex="-1"></a>        cur <span class="op">=</span> conn.cursor()</span>
<span id="cb34-88"><a href="#cb34-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-89"><a href="#cb34-89" aria-hidden="true" tabindex="-1"></a>        cur.execute(<span class="st">"""</span></span>
<span id="cb34-90"><a href="#cb34-90" aria-hidden="true" tabindex="-1"></a><span class="st">            CREATE TABLE IF NOT EXISTS registered_urls (</span></span>
<span id="cb34-91"><a href="#cb34-91" aria-hidden="true" tabindex="-1"></a><span class="st">                id SERIAL PRIMARY KEY,</span></span>
<span id="cb34-92"><a href="#cb34-92" aria-hidden="true" tabindex="-1"></a><span class="st">                url TEXT</span></span>
<span id="cb34-93"><a href="#cb34-93" aria-hidden="true" tabindex="-1"></a><span class="st">            )</span></span>
<span id="cb34-94"><a href="#cb34-94" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span>)</span>
<span id="cb34-95"><a href="#cb34-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-96"><a href="#cb34-96" aria-hidden="true" tabindex="-1"></a>        conn.commit()</span>
<span id="cb34-97"><a href="#cb34-97" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="st">"Database table initialized successfully."</span>)</span>
<span id="cb34-98"><a href="#cb34-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb34-99"><a href="#cb34-99" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"Error initializing database table: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-100"><a href="#cb34-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb34-101"><a href="#cb34-101" aria-hidden="true" tabindex="-1"></a>        conn.close()</span>
<span id="cb34-102"><a href="#cb34-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-103"><a href="#cb34-103" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(<span class="st">"/"</span>, methods<span class="op">=</span>[<span class="st">'GET'</span>, <span class="st">'POST'</span>])</span>
<span id="cb34-104"><a href="#cb34-104" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> home():</span>
<span id="cb34-105"><a href="#cb34-105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> request.method <span class="op">==</span> <span class="st">'POST'</span>:</span>
<span id="cb34-106"><a href="#cb34-106" aria-hidden="true" tabindex="-1"></a>        url <span class="op">=</span> request.form.get(<span class="st">'urlInput'</span>)</span>
<span id="cb34-107"><a href="#cb34-107" aria-hidden="true" tabindex="-1"></a>        confirmation_message <span class="op">=</span> process_url(url)</span>
<span id="cb34-108"><a href="#cb34-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">'display_url'</span>, url<span class="op">=</span>confirmation_message))</span>
<span id="cb34-109"><a href="#cb34-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb34-110"><a href="#cb34-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> render_template(<span class="st">'index.html'</span>)</span>
<span id="cb34-111"><a href="#cb34-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-112"><a href="#cb34-112" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(<span class="st">"/display_url/&lt;path:url&gt;"</span>, methods<span class="op">=</span>[<span class="st">'GET'</span>, <span class="st">'POST'</span>])</span>
<span id="cb34-113"><a href="#cb34-113" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> display_url(url: <span class="bu">str</span> <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb34-114"><a href="#cb34-114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> url:</span>
<span id="cb34-115"><a href="#cb34-115" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> request.method <span class="op">==</span> <span class="st">'POST'</span>:</span>
<span id="cb34-116"><a href="#cb34-116" aria-hidden="true" tabindex="-1"></a>            url2 <span class="op">=</span> request.form.get(<span class="st">'urlInput'</span>)</span>
<span id="cb34-117"><a href="#cb34-117" aria-hidden="true" tabindex="-1"></a>            confirmation_message <span class="op">=</span> process_url(url2)</span>
<span id="cb34-118"><a href="#cb34-118" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redirect(url_for(<span class="st">'display_url'</span>, url<span class="op">=</span>confirmation_message))</span>
<span id="cb34-119"><a href="#cb34-119" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb34-120"><a href="#cb34-120" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> render_template(<span class="st">'index.html'</span>, url<span class="op">=</span>url)</span>
<span id="cb34-121"><a href="#cb34-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb34-122"><a href="#cb34-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">'home'</span>))</span>
<span id="cb34-123"><a href="#cb34-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-124"><a href="#cb34-124" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(<span class="st">"/popular"</span>, methods<span class="op">=</span>[<span class="st">'GET'</span>])</span>
<span id="cb34-125"><a href="#cb34-125" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> top_favorite_websites_page():</span>
<span id="cb34-126"><a href="#cb34-126" aria-hidden="true" tabindex="-1"></a>    top_registered_urls <span class="op">=</span> retrieve_favorite_websites_from_redis()</span>
<span id="cb34-127"><a href="#cb34-127" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">'popular.html'</span>, top_registered_urls<span class="op">=</span>top_registered_urls)</span>
<span id="cb34-128"><a href="#cb34-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-129"><a href="#cb34-129" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb34-130"><a href="#cb34-130" aria-hidden="true" tabindex="-1"></a>    app.run(debug<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>After implementing this change in our application, we can verify that the <em>Top Favorite Websites</em> table is correctly retrieved from the Redis cache by rerunning the application. To do this, we will proceed to open a terminal window in the directory where our <strong>app.py</strong> is located and run the <code>flask run</code> command.</p>
<p>This will start our Flask application. Once the application is running, we will navigate to the Top Favorite Websites page. As shown in <a href="#fig-top-favorite-websites-page-redis-integration" class="quarto-xref">Figure&nbsp;15</a>, we should see the Top Favorite Websites table displayed correctly. This confirms that the data is now being successfully retrieved from the Redis cache.</p>
<div id="fig-top-favorite-websites-page-redis-integration" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-top-favorite-websites-page-redis-integration-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="assets/top-favorite-websites-page-after-redis-cache-integration.png" id="fig-top-favorite-websites-page-redis-integration" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-top-favorite-websites-page-redis-integration-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15
</figcaption>
</figure>
</div>
</section>
</section>
</section>
<section id="organizing-our-codebase" class="level2">
<h2 class="anchored" data-anchor-id="organizing-our-codebase">Organizing our codebase</h2>
<p>As applications evolve, they become more complex, and managing the various components within them can become increasingly difficult. In the case of our Celery and Flask applications, both have been structured as single files that contain all their relevant functionality. The Celery file, for example, manages configurations, Redis interactions, database operations, and task logic, while the Flask file handles routes, data validation, database operations, and application logic.</p>
<p>While this monolithic structure can work initially, it quickly leads to challenges as the application grows. The addition of more tasks, routes, configurations, and utility functions results in a cluttered codebase that becomes harder to navigate, debug, and extend. To ensure that our application remains scalable, maintainable, and easy to debug, it’s essential to refactor the code.</p>
<p>Refactoring involves breaking the application down into smaller, modular components, each with a clear and distinct responsibility. This approach allows us to better organize the code, reduce duplication, and simplify future updates and troubleshooting.</p>
<section id="centralizing-shared-logic" class="level3">
<h3 class="anchored" data-anchor-id="centralizing-shared-logic">Centralizing shared logic</h3>
<p>A crucial step in this refactoring process is identifying shared functionality between the Celery and Flask applications. Currently, both applications contain redundant pieces of logic that perform similar tasks. This duplication creates inefficiencies and increases the risk of inconsistencies. For instance, if a change is made in one part of the code, we may forget to update the other, leading to errors.</p>
<p>To address the issue of redundant code, we can centralize shared functionality into a single, dedicated location. The first step in refactoring our codebase is to identify and extract common elements that are used across both the Celery and Flask applications. Upon reviewing the code, we can see several shared components. For instance, the <strong>.env</strong> file for environment variables, and the connection methods for PostgreSQL and Redis databases. Instead of maintaining these functions separately in each application, we will consolidate them into a new folder, which we will call <strong>shared</strong>.</p>
<p>This <strong>shared</strong> folder will house all the common logic, making the code more maintainable and reducing duplication. We will start by moving the <strong>.env</strong> file into this folder and create two new Python files to manage the database connections: <strong>db.py</strong> for PostgreSQL and <strong>redis.py</strong> for Redis. These files will contain the necessary functions for connecting to the respective databases, ensuring each file is responsible for a specific service, which keeps our code modular and organized.</p>
<p>Below is the code for the <strong>db.py</strong> file, which will handle the connection to the PostgreSQL database. It loads the necessary environment variables and provides a function for connecting to the database.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> psycopg</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>db_user <span class="op">=</span> os.getenv(<span class="st">'DB_USER'</span>)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>db_password <span class="op">=</span> os.getenv(<span class="st">'DB_PASSWORD'</span>)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>db_host <span class="op">=</span> os.getenv(<span class="st">'DB_HOST'</span>)</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>db_port <span class="op">=</span> os.getenv(<span class="st">'DB_PORT'</span>)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>db_name <span class="op">=</span> os.getenv(<span class="st">'DB_NAME'</span>)</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> connect_to_database() <span class="op">-&gt;</span> psycopg.Connection <span class="op">|</span> <span class="va">None</span>:</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>        conn <span class="op">=</span> psycopg.<span class="ex">connect</span>(</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>            dbname<span class="op">=</span>db_name,</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>            user<span class="op">=</span>db_user,</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>            password<span class="op">=</span>db_password,</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>            host<span class="op">=</span>db_host,</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>            port<span class="op">=</span>db_port</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> conn</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Database connection error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Documenting code
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>As we enhance our codebase, one important aspect to prioritize alongside refactoring and improving code structure is documentation. Effective documentation is not limited to writing comments; it involves providing clear, accessible, and useful information that allows anyone interacting with the code, including our future selves, to understand it and use it effectively.</p>
<p>Good documentation should clearly explain what each function does, how it should be used, and what input it expects, so others can easily follow and utilize the code without needing to decipher its purpose.</p>
<section id="adding-documentation-in-python" class="level3">
<h3 class="anchored" data-anchor-id="adding-documentation-in-python">Adding documentation in Python</h3>
<p>In Python, the standard approach for documenting functions is by using <strong>docstrings</strong>—short for “documentation strings”—which are placed right after the function definition. Docstrings provide detailed information about a function’s behavior, inputs, outputs, and exceptions, making it easier to understand and maintain the code.</p>
<p>A docstring in Python is typically encapsulated within triple single quotes (<code>'''docstring'''</code>) or double quotes (<code>"""docstring"""</code>), and it can span multiple lines if necessary. The key here is to strike a balance between brevity and thoroughness. A well-written docstring should be informative, yet concise enough to be practical.</p>
<p>There are different conventions for writing docstrings in Python. In our case, we’ll use the <strong>Google Style</strong> docstring format. You can find more information about the Google Style guide <a href="https://google.github.io/styleguide/pyguide.html#38-comments-and-docstrings">here</a>.<br>
In essence, Google Style docstrings contain the following section:</p>
<ol type="1">
<li><p><strong>Summary Line</strong>: A short, one-liner describing what the function does. This should be concise and in the imperative mood (e.g., “Fetch data from a database”).</p></li>
<li><p><strong>Extended Description</strong> (optional): A more detailed explanation of what the function does, how it works, and any additional context that might be helpful.</p></li>
<li><p><strong>Args Section</strong>: A list of all the parameters the function takes. For each parameter, you provide:</p>
<ul>
<li><p>The name of the parameter.</p></li>
<li><p>A description of what the parameter is and its type (e.g., <code>str</code>, <code>int</code>).</p></li>
</ul></li>
<li><p><strong>Returns Section</strong>: This describes what the function returns and the type of the return value. If the function doesn’t return anything (i.e., returns <code>None</code>), this section can be omitted.</p></li>
<li><p><strong>Raises Section</strong>: This section lists any exceptions the function might raise and under what conditions. It’s important to document any errors that could occur, especially if they’re not immediately obvious from the function’s code.</p></li>
</ol>
<p>Let’s now look at an example of how to document a function using the Google Style docstring format by adding documentation to the <code>connect_to_database</code> function using the Google Style docstring format:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> connect_to_database() <span class="op">-&gt;</span> psycopg.Connection <span class="op">|</span> <span class="va">None</span>:</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Establishes a connection to the PostgreSQL database.</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co">    This function uses the psycopg library to connect to a</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="co">    PostgreSQL database using the credentials from the env file.</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="co">        psycopg.Connection: A connection object to the PostgreSQL database.</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Raises:</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Exception: If there is an error during the connection attempt.</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>        conn <span class="op">=</span> psycopg.<span class="ex">connect</span>(</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>            dbname<span class="op">=</span>db_name,</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>            user<span class="op">=</span>db_user,</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>            password<span class="op">=</span>db_password,</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>            host<span class="op">=</span>db_host,</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>            port<span class="op">=</span>db_port</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> conn</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Database connection error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>From now on, we will include proper documentation to all the refactored functions following the Google Style docstring format.</p>
</section>
</div>
</div>
</div>
<p>Similarly, the <strong>redis.py</strong> file in the <strong>shared</strong> folder will manage the Redis connection logic. It loads the Redis environment variables and provides a class to establish and manage the Redis connection.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> redis</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>redis_host <span class="op">=</span> os.getenv(<span class="st">'REDIS_HOST'</span>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>redis_port <span class="op">=</span> os.getenv(<span class="st">'REDIS_PORT'</span>)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RedisClient:</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co">    A Redis client for connecting to a Redis server.</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="co">    This class manages the connection to a Redis server using the </span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="co">    credentials loaded from environment variables.</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, host: <span class="bu">str</span>, port: <span class="bu">int</span>):</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>      <span class="co">"""</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Initializes the RedisClient and establishes a connection.</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="co">            host (str): The hostname or IP address of the Redis server.</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a><span class="co">            port (int): The port number of the Redis server.</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a><span class="co">        Raises:</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a><span class="co">            redis.ConnectionError: If the connection to the Redis server fails.</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.redis_host <span class="op">=</span> host</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.redis_port <span class="op">=</span> port</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.connection <span class="op">=</span> <span class="va">self</span>._connect()</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _connect(<span class="va">self</span>) <span class="op">-&gt;</span> redis.Redis:</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a><span class="co">        Establishes a connection to the Redis server.</span></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a><span class="co">        This method tries to connect to the Redis server using </span></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a><span class="co">        the provided host and port. </span></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a><span class="co">        If the connection fails, it logs an error and raises</span></span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a><span class="co">        an exception.</span></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a><span class="co">            redis.Redis: A Redis connection object.</span></span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a><span class="co">        Raises:</span></span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a><span class="co">            redis.ConnectionError: If the connection to the Redis server fails.</span></span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create a connection to the Redis server</span></span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redis.Redis(host<span class="op">=</span><span class="va">self</span>.redis_host, port<span class="op">=</span><span class="va">self</span>.redis_port)</span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> redis.<span class="pp">ConnectionError</span> <span class="im">as</span> e:</span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a>            logging.error(<span class="ss">f"Failed to connect to Redis: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span></span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a>redis_client <span class="op">=</span> RedisClient(redis_host, <span class="bu">int</span>(redis_port))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To make the <strong>shared</strong> folder easier to work with, we’ll add an <strong>__init__.py</strong> file inside it. This is necessary because Python treats any folder without an <strong>__init__.py</strong> file as a regular directory, meaning we can’t import it directly. Without this file, we would have to reference the folder with a dot (<code>.shared</code>) when importing, which is less intuitive.</p>
<p>In its simplest form, the <strong>__init__.py</strong> file can be empty. However, it can also include setup code or define what gets imported when the whole package is imported. Since we don’t need any extra behavior, we’ll keep it empty.</p>
<p>By adding the <strong>__init__.py</strong> file, we turn the <strong>shared</strong> folder into a Python package. This allows us to import components from it directly, like this:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shared.db <span class="im">import</span> connect_to_database</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shared.redis <span class="im">import</span> RedisClient</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After doing so, we no longer need to define PostgreSQL and Redis connection details separately in both the Flask and Celery applications. Instead, we can simply import them from <code>shared</code>.</p>
<p>To further improve our codebase, we’ll introduce a clearer separation of concerns by organizing the project into distinct folders. Alongside the <strong>shared</strong> folder, we will create two additional folders:</p>
<ul>
<li><p><strong>flask_app</strong> for all Flask-related code, including routes, models, and views.</p></li>
<li><p><strong>celery_app</strong> for Celery-related code, including background tasks, caching, and task queue management.</p></li>
</ul>
<p>After this reorganization, our project structure will look like this:</p>
<pre><code>favurls/
|- shared/                 (Common utilities used by both Flask and Celery)
|   │
|   │- __init__.py
|   |
│   │- db.py               (PostgreSQL database connection)
|   |
|   │- redis.py            (Redis connection)
|   |
│   |- .env                (File to store environmental variables)
│
│- flask_app/
|   |
|   │- (Flask-related code: routes, models, views)
|
|- celery_app/
|   |
│   |- (Celery-related code: caching, task queue)</code></pre>
</section>
<section id="organizing-celery-code" class="level3">
<h3 class="anchored" data-anchor-id="organizing-celery-code">Organizing Celery code</h3>
<p>Next, we’ll refactor the Celery-related code. Instead of having all Celery-related logic in one file, we will distribute responsibilities across four new files in the <strong>celery_app</strong> folder:</p>
<ul>
<li><p><strong>celery_config.py</strong>: This file will exclusively handle Celery configuration, including setting up the Celery instance, defining the task broker, and configuring periodic tasks.</p></li>
<li><p><strong>db.py</strong>: This file will contain functions related to interacting with the PostgreSQL database.</p></li>
<li><p><strong>redis.py</strong>: This file will manage all Redis-related interactions, such as managing the queue.</p></li>
<li><p><strong>tasks.py</strong>: This file will be dedicated to defining the Celery tasks themselves.</p></li>
</ul>
<p>If we take a closer look at this structure, we can observe that the <strong>db.py</strong> and <strong>redis.py</strong> files are primarily focused on utility functions. These functions serve the purpose of supporting the Celery tasks in interacting with PostgreSQL and Redis. As such, to improve organization and modularity, we can group these utility files into a dedicated <strong>utils</strong> folder within the <strong>celery_app</strong> directory. This will better reflect their role as utility modules and make the structure more intuitive.</p>
<p>To make importing from the <strong>utils</strong> folder easier, we’ll add an <strong>__init__.py</strong> file inside it. Just like with the <strong>shared</strong> folder, this file is necessary because it tells Python to treat the <strong>utils</strong> folder as a package.</p>
<p>After these changes, the folder structure for our Celery application will look as follows:</p>
<pre><code>celery_app/
|
│- celery_config.py    (Celery configuration)
|
│- utils/
│   │
│   │- __init__.py   
│   │
│   │- db.py           (PostgreSQL utility functions)
│   │
│   │- redis.py        (Redis utility functions)
|
│- tasks.py            (Celery task logic)</code></pre>
<section id="celery-configuration-celery_config.py" class="level4">
<h4 class="anchored" data-anchor-id="celery-configuration-celery_config.py">Celery configuration: celery_config.py</h4>
<p>Let’s begin by creating the <strong>celery_config.py</strong> file, where we will move the Celery configuration. This file will only include the Celery app definition, the beat schedule configuration, and the necessary Celery-related imports. In order to import the celery broker details we can do so from the redis module in the shared folder we previously we created</p>
<p>The resulting <strong>celery_config.py</strong> file will look like this:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> celery <span class="im">import</span> Celery</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shared.redis <span class="im">import</span> redis_host, redis_port</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the Celery instance</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>app_celery <span class="op">=</span> Celery(broker<span class="op">=</span><span class="ss">f"redis://</span><span class="sc">{</span>redis_host<span class="sc">}</span><span class="ss">:</span><span class="sc">{</span>redis_port<span class="sc">}</span><span class="ss">/0"</span>)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: You can put other configuration here if necessary</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>app_celery.conf.beat_schedule <span class="op">=</span> {</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cache-top-favorite-websites-every-30-mins'</span>: {</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">'task'</span>: <span class="st">'celery_app.tasks.cache_top_favorite_websites'</span>,</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'schedule'</span>: <span class="fl">30.0</span>,  <span class="co"># 30 minutes</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'dequeue-urls-every-5-mins'</span>: {</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">'task'</span>: <span class="st">'celery_app.tasks.process_queued_urls'</span>,</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">'schedule'</span>: <span class="fl">30.0</span>,  <span class="co"># 5 minutes</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that we now refer to tasks using their full names, like <code>celery_app.tasks.cache_top_favorite_websites</code>, instead of just calling the function directly by its name. This is because Celery needs a clear way to find and run the task. Since we’ve split the Celery logic into separate files, we need to tell Celery where the task is located by mentioning the file (or module) it’s in (<code>celery_app.tasks</code>), followed by the task’s name. This way, Celery can correctly identify and execute the task.</p>
</section>
<section id="database-functions-db.py" class="level4">
<h4 class="anchored" data-anchor-id="database-functions-db.py">Database functions: db.py</h4>
<p>Next, we will create the <strong>db.py</strong> file inside the <strong>utils</strong> folder. We will move here all the functions related to interacting with the PostgreSQL database. Since these functions need to connect to the PostgreSQL database, we’ll import the connection logic from the <code>shared</code> module to keep things organized.</p>
<p>Here is how the <strong>db.py</strong> file will look:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shared.db <span class="im">import</span> connect_to_database</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> insert_urls_to_database(urls: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Inserts a list of URLs into the registered_urls table in the database.</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="co">    This function establishes a connection to the database, </span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="co">    inserts the provided list of URLs into the `registered_urls`</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="co">    table, and commits the transaction.</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a><span class="co">        urls (List[str]): A list of URLs to be inserted into the database.</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Raises:</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a><span class="co">        Exception: If an error occurs while inserting data into the database.</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>        conn <span class="op">=</span> connect_to_database()</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>        cur <span class="op">=</span> conn.cursor()</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>        cur.executemany(<span class="st">"INSERT INTO registered_urls (url) VALUES (</span><span class="sc">%s</span><span class="st">)"</span>, [(url,) <span class="cf">for</span> url <span class="kw">in</span> urls])</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>        conn.commit()</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="ss">f"Inserted </span><span class="sc">{</span><span class="bu">len</span>(urls)<span class="sc">}</span><span class="ss"> URLs into the database."</span>)</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"Error inserting into the database: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>        conn.close()</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_top_registered_urls() <span class="op">-&gt;</span> List[Tuple[<span class="bu">str</span>, <span class="bu">int</span>]] <span class="op">|</span> <span class="va">None</span>:</span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a><span class="co">    Retrieves the top 10 most frequently registered URLs from the database.</span></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a><span class="co">    This function queries the `registered_urls` table to count </span></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a><span class="co">    the occurrences of each URL and returns the top 10 URLs with</span></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a><span class="co">    the highest count.</span></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a><span class="co">        List[Tuple[str, int]]: A list of tuples where each tuple </span></span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a><span class="co">                              contains a URL and the count of its</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a><span class="co">                              occurrences in the database.</span></span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a><span class="co">    Raises:</span></span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a><span class="co">        Exception: If an error occurs while retrieving data from the database.</span></span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>        conn <span class="op">=</span> connect_to_database()</span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>        cur <span class="op">=</span> conn.cursor()</span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a>        cur.execute(<span class="st">"""</span></span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a><span class="st">            SELECT url, COUNT(*) as count</span></span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a><span class="st">            FROM registered_urls</span></span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a><span class="st">            GROUP BY url</span></span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a><span class="st">            ORDER BY count DESC</span></span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a><span class="st">            LIMIT 10;</span></span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span>)</span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a>        top_registered_urls <span class="op">=</span> cur.fetchall()</span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> top_registered_urls</span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error retrieving the URLs: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> conn:</span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a>            conn.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="redis-functions-redis.py" class="level4">
<h4 class="anchored" data-anchor-id="redis-functions-redis.py">Redis functions: redis.py</h4>
<p>Similarly, we’ll create the <strong>redis.py</strong> file inside the <strong>utils</strong> folder to manage Redis-specific interactions. We will move the functions for dequeuing URLs from the Redis queue and caching popular URLs in Redis into this file. Just like with the database functions, we’ll import the Redis connection logic from the <code>shared</code> module.</p>
<p>Here’s how the <strong>redis.py</strong> file will be structured:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shared.redis <span class="im">import</span> redis_client</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dequeue_urls_from_redis(n: <span class="bu">int</span>) <span class="op">-&gt;</span> List[<span class="bu">str</span>]:</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Retrieves a specified number of URLs from the Redis queue and removes them.</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co">    This function extracts a range of URLs from the "url_queue"</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="co">    list in Redis, trims the queue to remove the processed URLs,</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="co">    and returns the decoded list of URLs.</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="co">        n (int): The maximum number of URLs to dequeue from the Redis queue.</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a><span class="co">        List[str]: A list of URLs dequeued from the Redis queue.</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a><span class="co">    Raises:</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Exception: If there is an error during the Redis operations.</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Start a Redis pipeline to batch operations</span></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>        url_dequeue_pipeline <span class="op">=</span> redis_client.connection.pipeline()</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract the specified range of values from the queue</span></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>        url_dequeue_pipeline.lrange(<span class="st">"url_queue"</span>, <span class="dv">0</span>, n<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Trim the queue to remove the processed values</span></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>        url_dequeue_pipeline.ltrim(<span class="st">"url_queue"</span>, n, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Execute the batch operations</span></span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>        urls <span class="op">=</span> url_dequeue_pipeline.execute()</span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If queue was trimmed, decode the extracted URLs from bytes to strings</span></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> urls[<span class="dv">1</span>]:</span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>            registered_urls <span class="op">=</span> [url.decode() <span class="cf">for</span> url <span class="kw">in</span> urls[<span class="dv">0</span>]]</span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>            registered_urls <span class="op">=</span> []</span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> registered_urls</span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Handle potential errors</span></span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"Failed to dequeue URLs from Redis: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_popular_to_redis(registered_urls: List[Tuple[<span class="bu">str</span>, <span class="bu">int</span>]]):</span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>        registered_urls_dict <span class="op">=</span> <span class="bu">dict</span>(registered_urls)</span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a>        redis_client.connection.delete(<span class="st">"top_favorite_websites"</span>)</span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a>        redis_client.connection.hset(<span class="st">"top_favorite_websites"</span>, mapping<span class="op">=</span>registered_urls_dict)</span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="st">"Successfully cached top favorite websites in Redis."</span>)</span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"Error when caching top favorite websites: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="celery-task-functions-tasks.py" class="level4">
<h4 class="anchored" data-anchor-id="celery-task-functions-tasks.py">Celery task functions: tasks.py</h4>
<p>Finally, we’ll create the <strong>tasks.py</strong> file, where we’ll move the Celery task functions. We will also import all the necessary functions from the <strong>utils</strong> folder that the tasks need to operate.</p>
<p>The <strong>tasks.py</strong> file will look like this:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .celery_config <span class="im">import</span> app_celery</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.redis <span class="im">import</span> dequeue_urls_from_redis, save_popular_to_redis</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.db <span class="im">import</span> insert_urls_to_database, get_top_registered_urls</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="at">@app_celery.task</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_queued_urls() <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="st">'Started processing queued URLs.'</span>)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    dequeued_urls <span class="op">=</span> dequeue_urls_from_redis(<span class="dv">150</span>)</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dequeued_urls:</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="ss">f'Retrieved </span><span class="sc">{</span><span class="bu">len</span>(dequeued_urls)<span class="sc">}</span><span class="ss"> URLs from Redis.'</span>)</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>        insert_urls_to_database(dequeued_urls)</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="ss">f'Inserted dequeued URLs into the PostgreSQL database.'</span>)</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="st">'No URLs retrieved from Redis.'</span>)</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="st">'Finished processing queued URLs.'</span>)</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a><span class="at">@app_celery.task</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cache_top_favorite_websites() <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="st">"Started caching top favorite websites."</span>)</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>    top_urls <span class="op">=</span> get_top_registered_urls()</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> top_urls:</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="ss">f"Retrieved top URLs from PostgreSQL."</span>)</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>        save_popular_to_redis(top_urls)</span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="st">"Successfully cached top favorite websites."</span>)</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="st">"No URLs retrieved from PostgreSQL, skipping caching."</span>)</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>    logging.info(<span class="st">"Finished caching process."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="executing-the-refactored-celery-application" class="level4">
<h4 class="anchored" data-anchor-id="executing-the-refactored-celery-application">Executing the refactored Celery application</h4>
<p>Now that we have refactored our Celery application, we can proceed to execute it. It’s likely that we would want to run the Celery application from the top-level folder of our project, instead of navigating into the <strong>celery_app</strong> folder every time. To make this possible, we need to ensure that the <code>celery_app</code> package is properly set up for execution from the root directory.</p>
<p>To achieve this, we need to add an <strong>__init__.py</strong> file in the <strong>celery_app</strong> folder. This <strong>__init__.py</strong> file is crucial because it turns the <strong>celery_app</strong> folder into a Python package, making it accessible for import. Additionally, in this case, this file won’t be empty. It needs to import the Celery application instance from <strong>celery_app.py</strong>. This allows us to directly execute Celery commands from the root folder, such as running the Celery worker or scheduling tasks with Celery Beat.</p>
<p>Here’s what the <strong>__init__.py</strong> file should contain:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .celery_config <span class="im">import</span> app_celery</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .tasks <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With the <strong>__init__.py</strong> in place, we can now execute the Celery worker from the root folder (<strong>favurls</strong>) using:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="ex">celery</span> <span class="at">-A</span> celery_app worker <span class="at">--loglevel</span><span class="op">=</span>info</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And the Celery Beat scheduler in another terminal instance with:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="ex">celery</span> <span class="at">-A</span> celery_app beat <span class="at">--loglevel</span><span class="op">=</span>info</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>An important step after creating this <strong>__init__.py</strong> file is updating our imports in <strong>tasks.py</strong>. Instead of importing utility functions directly from <code>utils</code>, it is better to import them from <code>celery_app.utils</code>. This is especially important as we continue refactoring and expanding our codebase, as we might introduce additional <code>utils</code> packages in other parts of the project.</p>
<p>Using a generic <code>utils</code> namespace across different parts of the project could lead to confusion or errors during refactoring, making it unclear which <code>utils</code> module a function belongs to.</p>
<p>Additionally, it is recommended to import all modules within <code>celery_app</code>, including configurations like <code>celery_config</code>, using the <code>celery_app</code> namespace. This ensures that the correct configurations are loaded from the intended package and prevents potential conflicts with similarly named modules elsewhere in the project.</p>
<p>With this change, our imports in <code>tasks.py</code> would now look like:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> celery_app.celery_config <span class="im">import</span> app_celery</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> celery_app.utils.redis <span class="im">import</span> dequeue_urls_from_redis, save_popular_to_redis</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> celery_app.utils.db <span class="im">import</span> insert_urls_to_database, get_top_registered_urls</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="organizing-flask-code" class="level3">
<h3 class="anchored" data-anchor-id="organizing-flask-code">Organizing Flask code</h3>
<p>Now, let’s focus on organizing our Flask application. Previously, all our Flask code was contained within a single folder named <strong>my_flask_app</strong>, where everything was bundled into a single file: <strong>app.py</strong>. As we just did with our Celery code, we will now distribute responsibilities across multiple files inside a new folder named <strong>flask_app</strong>.</p>
<p>We will create the following files, each serving a specific purpose:</p>
<ul>
<li><p><strong>validators.py</strong>: In this file we will place the function to validate URLs.</p></li>
<li><p><strong>redis.py:</strong> This file will manage all Redis-related interactions, such as enqueuing URLs into Redis or retrieving the cached top favorite websites.</p></li>
<li><p><strong>processors.py</strong>: This file will house the core logic for processing URLs, specifically the <code>process_urls</code> function.</p></li>
<li><p><strong>cli.py</strong>: This file will define our command-line utility for initializing the PostgreSQL database.</p></li>
<li><p><strong>routes.py</strong>: This file will define all Flask routes, handling incoming requests and responses.</p></li>
<li><p><strong>flask_config.py</strong>: This file will initialize our Flask application, register the routes from <strong>routes.py</strong> and the CLI command from <strong>cli.py</strong> into the Flask CLI.</p></li>
</ul>
<p>As we did with the Celery code, we will further improve organization by grouping related files into dedicated folders. We will create a <strong>utils</strong> folder to store utility-related files, such as <strong>redis.py</strong> for interacting with Redis and <strong>validators.py</strong> for URL validation. Additionally, we will introduce a <strong>services</strong> folder, where we will place <strong>processors.py</strong>, which contains the business logic for handling URLs. Both folders will include an <strong>__init__.py</strong> file to indicate that they are Python packages, allowing for cleaner imports and better modularity.</p>
<p>Furthermore, we will add an <strong>__init__.py</strong> file in the <strong>flask_app</strong> folder itself. This will allow the <strong>flask_app</strong> folder to be recognized as a Python package, enabling us to import components from it and maintaining clarity on where each component resides.</p>
<p>After these changes, our <strong>flask_app</strong> folder will be structured as follows:</p>
<pre><code>flask_app/
│- flask_config.py     (Flask application setup and route registration)
│ 
│- cli.py              (Database initialization command)
│ 
│- routes.py           (Route handling and request processing)
│ 
│- utils/     
│   │
│   │- __init__.py
│   │
│   │- redis.py        (Functions for interacting with Redis)
│   │
│   │- validators.py   (URL validation functions)
│   
│- services/
│   │
│   │- __init__.py
│   │
│   │- processors.py   (Handles URL processing logic)
│
│- templates/    
│   │
│   │- (Templates files)
│
│- static/    
│   │
│   │- (Static files)
│
│- __init__.py</code></pre>
<p>With this new structure in place, we can begin moving our code into these modular components.</p>
<section id="url-validation-validators.py" class="level4">
<h4 class="anchored" data-anchor-id="url-validation-validators.py">URL validation: validators.py</h4>
<p>We’ll start by moving the <code>is_valid_url</code> function, which checks whether a URL follows the correct format, to the <strong>validators.py</strong> file. This will help centralize validation logic.</p>
<p>Here’s how the <strong>validators.py</strong> file will be structured:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_valid_url(url: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    pattern <span class="op">=</span> <span class="vs">r"^(https?:\/\/)?(www\.)?[a-zA-Z0-9]+\.[a-zA-Z]+$"</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">bool</span>(re.fullmatch(pattern, url))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="redis-utility-functions-redis.py" class="level4">
<h4 class="anchored" data-anchor-id="redis-utility-functions-redis.py">Redis utility functions: redis.py</h4>
<p>Next, we’ll transfer all Redis-related interactions to the <strong>redis.py</strong> file inside the <code>utils</code> folder, which will include all the functions interacting with Redis, i.e., <code>enqueue_url_to_redis</code> and <code>retrieve_favorite_websites_from_redis</code>. We will also import the Redis connection logic from the <code>shared</code> module.</p>
<p>The <strong>redis.py</strong> file will look like this:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shared.redis <span class="im">import</span> redis_client</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> retrieve_favorite_websites_from_redis() <span class="op">-&gt;</span> List[Tuple[<span class="bu">str</span>, <span class="bu">int</span>]] <span class="op">|</span> <span class="va">None</span>:</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>   <span class="co">"""</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Retrieves the top favorite websites and their counts from Redis.</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="co">    This function fetches all the entries from the Redis hash</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="co">    "top_favorite_websites", decodes the URLs and their counts</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="co">    from bytes, and returns a list of tuples containing the </span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="co">    URLs and their corresponding counts.</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a><span class="co">        List[Tuple[str, int]]: A list of tuples where each tuple</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a><span class="co">        contains a URL and its associated count.</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Raises:</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a><span class="co">        Exception: If there is an error retrieving data from Redis.</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>        favorite_websites <span class="op">=</span> redis_client.connection.hgetall(<span class="st">"top_favorite_websites"</span>)</span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>        favorite_websites <span class="op">=</span> [(url.decode(), <span class="bu">int</span>(count)) <span class="cf">for</span> url, count <span class="kw">in</span> favorite_websites.items()]</span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> favorite_websites</span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"Error retrieving favorite websites from Redis: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> enqueue_url_to_redis(url: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a><span class="co">    Adds a URL to the Redis queue.</span></span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a><span class="co">    This function pushes the specified URL onto the Redis list "url_queue".</span></span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a><span class="co">        url (str): The URL to be enqueued to Redis.</span></span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a><span class="co">    Raises:</span></span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a><span class="co">        Exception: If there is an error sending the URL to the Redis queue.</span></span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Push the URL to a Redis queue (list)</span></span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a>        redis_client.connection.lpush(<span class="st">"url_queue"</span>, url)</span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a>        logging.debug(<span class="ss">f"URL enqueued to Redis: </span><span class="sc">{</span>url<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb51-46"><a href="#cb51-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb51-47"><a href="#cb51-47" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"Error sending URL to Redis queue: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="url-processsing-logic-processors.py" class="level4">
<h4 class="anchored" data-anchor-id="url-processsing-logic-processors.py">URL processsing logic: processors.py</h4>
<p>In the <strong>processors.py</strong> file, we will move all the code that handles URL processing, which in our case refers to the <code>process_url</code> function. To achieve this, we first need to import a couple of functions from other parts of the application. The first is the <code>is_valid_url</code> function, which is found in the <strong>validators.py</strong> file within the <strong>utils</strong> directory. The second import is <code>enqueue_url_to_redis</code> from the <strong>redis.py</strong> file, also located within the <strong>utils</strong> directory.</p>
<p>The <strong>processors.py</strong> file should now look like this:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask_app.utils.validators <span class="im">import</span> is_valid_url</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask_app.utils.redis <span class="im">import</span> enqueue_url_to_redis</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_url(url: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Validates and processes the provided URL.</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="co">    This function checks if the provided URL is valid. If valid,</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="co">    it enqueues the URL to the Redis queue and returns a success</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="co">    message. If the URL is invalid, it returns an error message</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="co">    indicating the issue.</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a><span class="co">        url (str): The URL to be validated and processed.</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="co">        str: A confirmation message indicating whether </span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a><span class="co">            the URL was successfully registered or if</span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a><span class="co">            the URL format was invalid.</span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a><span class="co">    Raises:</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a><span class="co">        None</span></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_valid_url(url):</span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>        enqueue_url_to_redis(url)</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>        confirmation_message <span class="op">=</span> <span class="st">"You have successfully registered the following URL: "</span> <span class="op">+</span> url</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>        confirmation_message <span class="op">=</span> <span class="st">"The URL you entered is not valid. Please check the format and try again."</span></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> confirmation_message</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="command-line-interface-cli-utility-cli.py" class="level4">
<h4 class="anchored" data-anchor-id="command-line-interface-cli-utility-cli.py">Command-line interface (CLI) utility: cli.py</h4>
<p>Next, we’ll centralize all command-line interface (CLI) functions into <strong>cli.py</strong>.</p>
<p>Currently, we only have one CLI function, <code>create_table</code>, which is responsible for setting up the database schema. Since this function interacts with the PostgreSQL database, we will also import the <code>connect_to_database</code> function from the shared module to handle the database connection.</p>
<p>With these changes, our <strong>cli.py</strong> file will be structured as follows:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shared.db <span class="im">import</span> connect_to_database</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_table() <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">"""</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Create the 'registered_urls' table in the database if</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="co">    it does not already exist.</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="co">    This function establishes a connection to the database,</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="co">    creates a table named 'registered_urls' with columns </span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="co">    'id' (as a SERIAL PRIMARY KEY) and 'url' (as TEXT), </span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="co">    and commits the changes. If the table already exists,</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="co">    no changes are made.</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Raises:</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a><span class="co">        psycopg.DatabaseError: If an error occurs during</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a><span class="co">                               the table creation process.</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>        conn <span class="op">=</span> connect_to_database()</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>        cur <span class="op">=</span> conn.cursor()</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>        cur.execute(<span class="st">"""</span></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a><span class="st">            CREATE TABLE IF NOT EXISTS registered_urls (</span></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a><span class="st">                id SERIAL PRIMARY KEY,</span></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a><span class="st">                url TEXT</span></span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a><span class="st">            )</span></span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span>)</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>        conn.commit()</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="st">"Database table initialized successfully."</span>)</span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>        logging.error(<span class="ss">f"Error initializing database table: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>        conn.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="route-handling-routes.py" class="level4">
<h4 class="anchored" data-anchor-id="route-handling-routes.py">Route Handling: routes.py</h4>
<p>Similarly, we will centralize all route-related functions into the <strong>routes.py</strong> file. To achieve this, we will need to import several functions that our route functions depend on, such as <code>retrieve_favorite_websites_from_redis</code> from <code>redis.py</code> and <code>process_url</code> from <code>processors.py</code>.</p>
<p>Once the necessary imports are in place, we can move all route-related functions into this file.</p>
<p>Here’s how the <strong>routes.py</strong> file will be structured:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask_app.utils.redis <span class="im">import</span> retrieve_favorite_websites_from_redis</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> request, render_template, redirect, url_for</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask_app.services.processors <span class="im">import</span> process_url </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> home():</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">"""</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Render the home page and handle form submissions.</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="co">    If the request method is 'POST', it processes the</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="co">    submitted URL and redirects to the 'display_url' </span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="co">    route with a confirmation message. Otherwise, it </span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="co">    renders the home page template.</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a><span class="co">        flask.Response: A rendered template for GET</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a><span class="co">                        requests or a redirect for </span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a><span class="co">                        POST requests.</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> request.method <span class="op">==</span> <span class="st">'POST'</span>:</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>        url <span class="op">=</span> request.form.get(<span class="st">'urlInput'</span>)</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>        confirmation_message <span class="op">=</span> process_url(url)</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">'display_url'</span>, url<span class="op">=</span>confirmation_message))</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> render_template(<span class="st">'index.html'</span>)</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> display_url(url: <span class="bu">str</span> <span class="op">|</span> <span class="va">None</span> <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">"""</span></span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a><span class="co">    Display a processed URL or redirect to the home</span></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a><span class="co">    page if no URL is provided.</span></span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a><span class="co">    If a URL is given, it renders the index page with</span></span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a><span class="co">    the URL. If the request method is 'POST', it </span></span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a><span class="co">    processes a new URL and redirects to the same </span></span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a><span class="co">    route with the updated confirmation message. </span></span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a><span class="co">    If no URL is provided, it redirects to the home page.</span></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a><span class="co">        url (str, optional): The processed URL to be </span></span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a><span class="co">                             displayed. Defaults to None.</span></span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a><span class="co">        flask.Response: A rendered template for GET </span></span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a><span class="co">                        requests or a redirect for </span></span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a><span class="co">                        POST requests.</span></span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> url:</span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> request.method <span class="op">==</span> <span class="st">'POST'</span>:</span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a>            url2 <span class="op">=</span> request.form.get(<span class="st">'urlInput'</span>)</span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a>            confirmation_message <span class="op">=</span> process_url(url2)</span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redirect(url_for(<span class="st">'display_url'</span>, url<span class="op">=</span>confirmation_message))</span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> render_template(<span class="st">'index.html'</span>, url<span class="op">=</span>url)</span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">'home'</span>))</span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> top_favorite_websites_page():</span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a>  <span class="co">"""</span></span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a><span class="co">    Render the top favorite websites page with the</span></span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a><span class="co">    most popular registered URLs.</span></span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true" tabindex="-1"></a><span class="co">    Retrieves the top registered URLs from Redis</span></span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true" tabindex="-1"></a><span class="co">    and displays them on the 'popular.html' template.</span></span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-64"><a href="#cb54-64" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb54-65"><a href="#cb54-65" aria-hidden="true" tabindex="-1"></a><span class="co">        flask.Response: A rendered template with the</span></span>
<span id="cb54-66"><a href="#cb54-66" aria-hidden="true" tabindex="-1"></a><span class="co">                        top registered URLs.</span></span>
<span id="cb54-67"><a href="#cb54-67" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb54-68"><a href="#cb54-68" aria-hidden="true" tabindex="-1"></a>    top_registered_urls <span class="op">=</span> retrieve_favorite_websites_from_redis()</span>
<span id="cb54-69"><a href="#cb54-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">'popular.html'</span>, top_registered_urls<span class="op">=</span>top_registered_urls)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that here, we avoid importing utils directly and instead specify the full module path, just as we did in our Celery <strong>tasks.py</strong> file. This ensures that we clearly reference the correct utilities for each part of the application. As we now have both <code>celery_app.utils</code> and <code>flask_app.utils</code>, failing to specify the correct module could lead to conflicts, incorrect imports, or confusion when maintaining the code.</p>
</section>
<section id="flask-app-configuration-flask_config.py" class="level4">
<h4 class="anchored" data-anchor-id="flask-app-configuration-flask_config.py">Flask app configuration: flask_config.py</h4>
<p>Finally, we will move the creation and configuration of the Flask app into the <strong>flask_config.py</strong> file, centralizing all configurations related to the application’s instance and routes.</p>
<p>To achieve this, we will first import all the necessary components for the Flask app, such as the route functions (<code>home</code>, <code>display_url</code>, and <code>tracked_page</code>) that we previously moved into the <strong>routes.py</strong> file, and then import the <code>create_table</code> function from <strong>cli.py</strong> to associate it with the Flask CLI commands.</p>
<p>With these components, the <strong>flask_config.py</strong> file will look as follows:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> Flask</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask_app.routes <span class="im">import</span> home, display_url, tracked_page</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask_app.cli <span class="im">import</span> create_table</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> Flask(<span class="va">__name__</span>)</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>app.add_url_rule(<span class="st">"/"</span>, view_func<span class="op">=</span>home)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>app.add_url_rule(<span class="st">"/display_url/&lt;path:url&gt;"</span>, view_func<span class="op">=</span>display_url)</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>app.add_url_rule(<span class="st">"/popular"</span>, view_func<span class="op">=</span>tracked_page)</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>app.cli.add_command(<span class="st">"init_db_table"</span>, create_table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="executing-the-refactored-flask-application" class="level4">
<h4 class="anchored" data-anchor-id="executing-the-refactored-flask-application">Executing the refactored Flask application</h4>
<p>Now that we have refactored the code for our Flask application, we can proceed to run the application from the root directory, just like we did with Celery.</p>
<p>To make this possible, we need to ensure that Flask is properly configured for execution. One way to achieve this is by adding a <strong>__init__.py</strong> file in the <strong>flask_app</strong> folder. This file will help convert the folder into a Python package, allowing us to import and run the Flask application easily.</p>
<p>The <strong>__init__.py</strong> file should import the <code>app</code> instance from the <strong>flask_config.py</strong> file so that we can run it directly.</p>
<p>Here’s what the <strong>__init__.py</strong> file should contain:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .flask_config <span class="im">import</span> app</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After having created our <strong>__init__.py</strong> file, we can run the Flask application from the root folder (<strong>favurls</strong>) by using the following command:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="ex">flask</span> run</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>However, after executing this command, you may encounter an error message that states that Flask could not locate the application, as showin in <a href="#fig-flask-run-error-no-flask-application" class="quarto-xref">Figure&nbsp;16</a>. This happens because, by default, Flask looks for a file named <strong>app.py</strong> or <strong>wsgi.py</strong> in the directory where the <code>flask run</code> command is executed. Since we don’t have either of these files in the root directory, Flask fails to identify the application and throws an error.</p>
<div id="fig-flask-run-error-no-flask-application" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-flask-run-error-no-flask-application-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="assets/flask-run-after-refactoring.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-flask-run-error-no-flask-application-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;16: Flask error for missing application file
</figcaption>
</figure>
</div>
<p>Unlike Celery, where adding an <strong>__init__.py</strong> file in the package allows us to run Celery commands from the root directory, Flask requires a specific entry point to identify and run the application.</p>
<p>To fix this issue, we need to create an entry point for Flask in the root directory. This involves creating a new file in the root directory, which we will call <strong>app.py</strong>, and in which we define the Flask application to serve as the entry point for our Flask application.</p>
<p>However, before creating <strong>app.py</strong>, we will make some changes to our <strong>flask_config.py</strong> file. Right now, our <strong>flask_config.py</strong> file creates and configures the Flask application immediately when the module is loaded. While this works fine for simple setups, it can lead to unintended side effects when modules are imported elsewhere. To prevent this and gain better control over the app’s initialization, we will wrap the entire configuration into a function called <code>create_app</code>. This change means that the app isn’t created until we explicitly call <code>create_app</code>, allowing us to avoid the pitfalls of premature instantiation.</p>
<p>After implementing these changes, the <strong>flask_config.py</strong> file will look like this:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> Flask</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask_app.routes <span class="im">import</span> home, display_url, top_favorite_websites_page</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask_app.cli <span class="im">import</span> create_table</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_app() <span class="op">-&gt;</span> Flask:</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Initialize and configure the Flask application.</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="co">    This function creates an instance of the Flask application,</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="co">    registers URL routes, and adds CLI commands.</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Flask: The configured Flask application instance.</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>    app <span class="op">=</span> Flask(<span class="va">__name__</span>)</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Register URL routes</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>    app.add_url_rule(<span class="st">"/"</span>, view_func<span class="op">=</span>home)</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>    app.add_url_rule(<span class="st">"/display_url/&lt;path:url&gt;"</span>, view_func<span class="op">=</span>display_url)</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>    app.add_url_rule(<span class="st">"/popular"</span>, view_func<span class="op">=</span>top_favorite_websites_page)</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Register CLI commands</span></span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>    app.cli.add_command(<span class="st">"init_db_table"</span>, create_table)</span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> app</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Following these changes, we also need to update the <strong>__init__.py</strong> file in the <strong>flask_app</strong> folder. Instead of importing a pre-configured app instance, we now import the create_app function. The updated <strong>__init__.py</strong> will now look like this:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .flask_config <span class="im">import</span> create_app </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now that we have updated the <strong>flask_config.py</strong> and <strong>__init__.py</strong> files, we can now create the <strong>app.py</strong> file in the root folder to serve as the explicit entry point for our Flask application. In this file, we will import the <code>create_app</code> function from our <code>flask_app</code> package and use it to instantiate our application.</p>
<p>Here’s the code for <strong>app.py</strong>:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask_app <span class="im">import</span> create_app </span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> create_app()  <span class="co"># Create an instance of the Flask app</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    app.run() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With all the changes in place, we can now successfully run the Flask application. Simply execute <code>flask run</code> from the terminal in the root folder, and the Flask server will start without any errors, making the application accessible.</p>
</section>
</section>
</section>
<section id="containerizing-the-refactored-application" class="level2">
<h2 class="anchored" data-anchor-id="containerizing-the-refactored-application">Containerizing the refactored application</h2>
<p>In the <a href="../../../posts/2024/intro-to-docker/">previous post on data-driven web applications</a>, we discussed the benefits of containerization and successfully containerized our Flask application. Since then, we have modified our application to improve performance and scalability. Instead of directly inserting submitted URLs into PostgreSQL, we now enqueue them in Redis for more efficient processing. Additionally, we cache the most popular websites in Redis rather than recomputing them for each user query. To support these changes, we have introduced a Celery service to handle background tasks such as processing submitted URLs and managing the cache. This means we now need to containerize both the Flask and Celery applications while ensuring they interact seamlessly. To achieve this, we will containerize them separately, allowing us to scale each service independently based on its specific workload.</p>
<section id="containerizing-the-flask-application" class="level3">
<h3 class="anchored" data-anchor-id="containerizing-the-flask-application">Containerizing the Flask application</h3>
<p>Let’s start by containerizing the Flask application, building upon the work we did in the <a href="../../../posts/2024/intro-to-docker/">previous post</a> while taking into account the recent changes.</p>
<p>The first task is to update the <strong>requirements.txt</strong> file to include the new Redis library. There are a couple of ways to do this, such as using <code>pipreqs</code> to automatically generate the list of dependencies or manually adding the required packages. Since Redis is now part of our application stack, we need to ensure it’s included in our dependencies.</p>
<p>Here is an updated version of the <strong>requirements.txt</strong> file:</p>
<pre><code>Flask==3.0.2
python-dotenv==1.0.1
psycopg==3.2.1
redis==5.2.1</code></pre>
<p>Next, we will create a Dockerfile specifically for the Flask application. Since we have two components—Flask and Celery—it’s better to name the Dockerfiles differently for clarity. We will call this file <code>Dockerfile_flask_app</code>. This file will be placed in the root folder of the project (i.e., <strong>favurls</strong>), which will allow us to easily differentiate it from the Celery Dockerfile.</p>
<p>In this file we only need to change very few parts regarding the Dockerfile we already created in the <a href="../../../posts/2024/intro-to-docker/">previous post</a>. Specifically, we need to copy the <strong>shared</strong> folder (which contains functions to connect to Redis and PostgreSQL), the <strong>flask_app</strong> folder (where the main logic resides), and the <strong>app.py</strong> entry point.</p>
<p>Here is the updated <strong>Dockerfile_flask_app</strong>:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the Python 3.12.4 image as the base</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> python:3.12.4</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the working directory inside the container</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy the requirements file and install the dependencies</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> flask_app/requirements.txt /app</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy the rest of the application code</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> shared /app/shared</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> flask_app /app/flask_app</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> app.py /app</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the environment variable to specify the Flask application file</span></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> FLASK_APP=app.py</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the Flask application with the host set to 0.0.0.0 to allow external access</span></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">"flask"</span>, <span class="st">"run"</span>, <span class="st">"-h"</span>, <span class="st">"0.0.0.0"</span>, <span class="st">"-p"</span>, <span class="st">"5000"</span>]</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Expose port 5000 for external access</span></span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPOSE</span> 5000</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After updating the <strong>Dockerfile_flask_app</strong>, we can build the Docker image. Since we are using a custom name for the Dockerfile, we need to specify it using the <code>-f</code> flag. Additionally, we will tag the image with an easy to idenfy name using the <code>-t</code> flag, such as favurls_flask_app.</p>
<p>Here’s the command to build the image:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-f</span> Dockerfile_flask_app <span class="at">-t</span> favurls_flask_app .</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Once the image is built, we can run the container. However, since we need to connect the Flask application to the Redis service running locally, we must configure the container to use the local Redis instance. This can be done by specifying the <code>--network="host"</code> flag to ensure that the container shares the host network and can access Redis. In addition, we set the <code>REDIS_HOST</code> environment variable to point to the local Redis instance.</p>
<p>Once the image is built, we can run the container. However, containers are, by default, isolated from the host machine’s network. This means that without any additional configuration, the container won’t be able to access services running on the host, such as the local Redis instance. To enable the container to connect to Redis, we need to configure it to share the host’s network. This is done by using the <code>--network="host"</code> flag when running the container.</p>
<p>Here’s the command to run the Flask container:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">--rm</span> <span class="at">--network</span><span class="op">=</span><span class="st">"host"</span> <span class="at">-e</span> REDIS_HOST=127.0.0.1 <span class="at">-p</span> 5000:5000 <span class="at">--name</span> favurls_flask_app_container favurls_flask_app</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that in this command, we set the <code>REDIS_HOST</code> environment variable to point to the local Redis instance. While this is already defined in the <code>.env</code> file, we explicitly set it in the container configuration as a convenient way to adjust it if needed, making it easier to update or change the Redis host without modifying the <code>.env</code> file directly.</p>
</section>
<section id="containerizing-the-celery-application" class="level3">
<h3 class="anchored" data-anchor-id="containerizing-the-celery-application">Containerizing the Celery application</h3>
<p>Now that we have successfully containerized the Flask application, we can proceed to containerize the Celery application.</p>
<p>As with Flask, the first step will be to create a <strong>requirements.txt</strong> file for the Celery app, which we will place in the <strong>celery_app</strong> folder. This file will list the necessary dependencies to ensure that Celery works seamlessly with Redis and PostgreSQL:</p>
<pre><code>celery==5.4.0
python-dotenv==1.0.1
psycopg==3.2.1
redis==5.2.1</code></pre>
<p>Now, we’ll create a separate Dockerfile for the Celery application. To maintain clarity and avoid confusion with the Flask Dockerfile, we’ll name this file <strong>Dockerfile_celery_app</strong>, which we will also place in the root folder (<strong>favurls</strong>)</p>
<p>This Dockerfile will be quite similar to the one we created for the Flask application, but with a few important differences. First, we only need to copy the <strong>shared</strong> and <strong>celery_app</strong> folders, as those contain the necessary code for Celery. Additionally, since Celery doesn’t need to expose any ports (it’s not handling HTTP requests like Flask), we won’t need to include an <code>EXPOSE</code> instruction. Finally, we’ll adjust the <code>CMD</code> to run both the Celery worker and Celery beat services, which are required for processing background tasks and scheduling periodic tasks, respectively.</p>
<p>Here’s how the <strong>Dockerfile_celery_app</strong> will look like:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the Python 3.12.4 image as the base</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> python:3.12.4</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the working directory inside the container</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy the requirements file and install the dependencies</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> celery_app/requirements.txt /app</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy the rest of the application code</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> shared /app/shared</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> celery_app /app/celery_app</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Run Celery worker and beat in the background</span></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">"sh"</span>, <span class="st">"-c"</span>, <span class="st">"celery -A celery_app worker --loglevel=info &amp; celery -A celery_app beat --loglevel=info"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After creating this <strong>Dockerfile_celery_app</strong>, we can build the image for the Celery application. We use the same process as before, specifying the custom Dockerfile and tagging the image with a recognizable name:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-f</span> Dockerfile_celery_app <span class="at">-t</span> favurls_celery_app .</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Once the image is built, we can run the Celery container. As with the Flask application, the Celery app needs to connect to Redis running locally, so <code>--network="host"</code> flag in order to access Redis running locally. However in this case we do not need to expose any port, so we do not need to set the -p</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">--rm</span> <span class="at">--network</span><span class="op">=</span><span class="st">"host"</span> <span class="at">-e</span> REDIS_HOST=127.0.0.1 <span class="at">--name</span> favurls_celery_app_container favurls_celery_app</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can unfold the section below, to see how our file structure will look like after all these changes.</p>
<details>
<summary>
Updated file structure
</summary>
<pre><code>favurls/
|
|-  app.py                        (Entrypoint for Flask application)
|
|-  Dockerfile_celery_app         (Dockerfile for Celery application)
|
|-  Dockerfile_flask_app          (Dockerfile for Flask application)
|
|- shared/                        (Common utilities used by both Flask and Celery)
|   │
|   │- __init__.py
|   |
│   │- db.py                      (PostgreSQL database connection)
|   |
|   │- redis.py                   (Redis connection)
|   |
│   |- .env                       (File to store environmental variables)
│
│- flask_app/
│   │
│   │- __init__.py
│   │
│   │- requirements.txt
│   │
|   │- flask_config.py            (Flask application setup and route registration)
|   │ 
|   │- cli.py                     (Database initialization command)
|   │ 
|   │- routes.py                  (Route handling and request processing)
|   │ 
|   │- utils/   
|   │   │
|   │   │- __init__.py
|   │   │
|   │   │- redis.py               (Functions for interacting with Redis)
│   │   │
|   │   │- validators.py          (URL validation functions)
|   │
|   │- services/
|   │   │
|   │   │- __init__.py
|   │   │
|   │   │- processors.py           (Handles URL processing logic)
|   │ 
|   │- templates/                  (Folder to store HTML templates)
|   │    |
|   │    |- base_template.html     (HTML template for the base template)
|   │    |
|   │    |- index.html             (HTML template for the main page)
|   │    |
|   │    |- navbar.html            (HTML template for the navigation bar)
|   │    |
|   │    |- popular.html           (HTML template for the top favorite websites page)
|   │
|   │- static/                     (Folder to store static files such as CSS, JavaScript, images, etc.)
|   │    |
|   │    |- styles                 (Folder to store style sheets, such as CSS files)
|   │    |
|   │    |- base_template.css      (CSS file to style the base template elements)
|   │    |
|   │    |- home.css               (CSS file to style the main page)
|   │    |
|   │    |- navbar.css             (CSS file to style the navigation)
|   │    |
|   │    |- popular.css            (CSS file to style the top favorite websites page)
|
|- celery_app/
│   │
│   │- __init__.py
│   │
│   │- requirements.txt
|   │ 
|   │- celery_config.py            (Celery configuration)
|   │
|   │- utils/
│   |   │
│   |   │- __init__.py   
│   |   │
│   |   │- db.py                   (PostgreSQL utility functions)
│   |   │
│   |   │- redis.py                (Redis utility functions)
|   │
|   │- tasks.py                    (Celery task logic)</code></pre>
</details>
<div class="callout callout-style-simple callout-tip no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p>You can click the button below to download the zip file containing all the refactored code, including the Dockerfiles.</p>
<div class="button_container">
<form method="get" action="assets/favurls.zip">
<button type="submit" class="download_button">
<p>Download</p>
</button>
</form>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this post, we built on our previous work by refining our application to better handle real-world traffic and improve performance. We began by revisiting our application’s core functionality—a system where users can submit their favorite website URLs via the Home page, with the data stored in a PostgreSQL database—and the subsequent display of the top favorite websites on a dedicated page. Although the app performed well during development, as we started considering production, we identified potential scalability issues that could overwhelm the database.</p>
<p>To address these challenges, we introduced a more sophisticated data handling strategy. Instead of inserting each URL submission directly into PostgreSQL, we now enqueue submissions in Redis, an in-memory key-value store known for its speed. This adjustment allows us to batch multiple insert operations, which are processed periodically by a Celery worker every five minutes, significantly reducing the load on the database during peak times. At the same time, we addressed the inefficiency of querying the database for the top favorite websites with every request by precomputing these results every thirty minutes and caching them in Redis, ensuring users receive information quickly without repeatedly straining the system.</p>
<p>Beyond performance improvements, we also restructured our codebase for better organization and long-term maintainability. We refactored our previously monolithic Flask and Celery applications into smaller, modular components, centralizing shared functionality—such as database and Redis connection logic—in a dedicated shared folder with files like <strong>db.py</strong> and <strong>redis.py.</strong> Additionally, we adopted comprehensive documentation practices using Google Style docstrings, providing clear explanations of function behaviors, expected inputs, and outputs.</p>
<p>Despite all these changes, it is worth mentioning that our application is not yet perfect. We’ve kept the scope of these changes manageable for illustrative purposes, focusing on providing a good example of architectural improvements that could already significantly enhance the application. However, additional improvements could further elevate the app. For instance, implementing user identification would help prevent duplicate URL submissions and improve data integrity. Another enhancement could involve optimizing the cache update process: instead of fully rebuilding the cache every thirty minutes, we could register URL submissions before they’re added to the database and only update the cache with new URLs since the last update. This would help maintain cache freshness while minimizing overhead.</p>


</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<div class="giscus">
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</div></body></html>